import{H as y,p as L,q as Ae}from"./vendor-lark.6ef72961.js";import{j as Pe,$ as t}from"./vendor-jquery.88f4ff12.js";import{i,B as Ue}from"./vendor-i18n.7cd67a60.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))l(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&l(d)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function l(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const Ne="\u5C0F\u7EA2\u4E66\u7B14\u8BB0\u63D0\u53D6",Re="\u6279\u91CF\u91C7\u96C6\u5C0F\u7EA2\u4E66\u7B14\u8BB0\u6570\u636E\u5E76\u5904\u7406\u56FE\u7247\u9644\u4EF6",Me={selectTable:"\u9009\u62E9\u6570\u636E\u8868",selectTablePlaceholder:"\u8BF7\u9009\u62E9\u6570\u636E\u8868",selectColumn:"\u9009\u62E9\u7B14\u8BB0\u94FE\u63A5\u5217",selectColumnPlaceholder:"\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868",selectColumnHint:"\u8BF7\u9009\u62E9\u5305\u542B\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID\u7684\u5217\uFF08\u6587\u672C\u6216\u94FE\u63A5\u7C7B\u578B\uFF09",selectFields:"\u9009\u62E9\u8981\u6DFB\u52A0\u7684\u5B57\u6BB5",selectAll:"\u5168\u9009",deselectAll:"\u53CD\u9009",cookieInput:"Cookie",cookieRequired:"\u5FC5\u586B\u9879\uFF0C\u7528\u4E8E\u5C0F\u7EA2\u4E66\u7B14\u8BB0\u6570\u636E\u6293\u53D6\u3002\u8F93\u5165\u540E\u81EA\u52A8\u4FDD\u5B58\uFF0C\u4E0B\u6B21\u8BBF\u95EE\u81EA\u52A8\u586B\u5145",cookieLink:"Cookie\u83B7\u53D6\u65B9\u6CD5",startProcessing:"\u5F00\u59CB\u5904\u7406",pauseProcessing:"\u6682\u505C\u5904\u7406",resumeProcessing:"\u7EE7\u7EED\u5904\u7406",requiredField:"\u63D0\u793A\u4FE1\u606F\uFF08\u5FC5\u9009\uFF09",requiredFieldHint:"\u7528\u4E8E\u663E\u793A\u5904\u7406\u72B6\u6001\u3001\u9519\u8BEF\u4FE1\u606F\u6216\u6210\u529F\u6D88\u606F"},Oe={noteId:"\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID",authorNickname:"\u535A\u4E3B\u6635\u79F0",authorRedId:"\u535A\u4E3B\u5C0F\u7EA2\u4E66\u53F7",authorXhsUrl:"\u535A\u4E3B\u4E3B\u9875\u94FE\u63A5",authorFansCount:"\u535A\u4E3B\u7C89\u4E1D\u6570",authorDesc:"\u535A\u4E3B\u7B80\u4ECB",title:"\u7B14\u8BB0\u6807\u9898",description:"\u7B14\u8BB0\u5185\u5BB9",noteType:"\u7B14\u8BB0\u7C7B\u578B",publishTime:"\u53D1\u5E03\u65F6\u95F4",coverUrl:"\u5C01\u9762\u56FE",images:"\u56FE\u7247\u5217\u8868",videoUrl:"\u89C6\u9891\u5730\u5740",videoDuration:"\u89C6\u9891\u65F6\u957F",tags:"\u8BDD\u9898\u5217\u8868",likes:"\u70B9\u8D5E\u6570",collects:"\u6536\u85CF\u6570",shares:"\u8F6C\u53D1\u6570",comments:"\u8BC4\u8BBA\u6570",ipLocation:"\u53D1\u6587\u5730\u5740",dataFetchTime:"\u6570\u636E\u83B7\u53D6\u65F6\u95F4",errorMsg:"\u63D0\u793A\u4FE1\u606F"},ze={video:"\u89C6\u9891\u7B14\u8BB0",image:"\u56FE\u6587\u7B14\u8BB0",text:"\u6587\u672C\u7B14\u8BB0"},Ve={processing:"\u5904\u7406\u4E2D",processingProgress:"\u5904\u7406\u8FDB\u5EA6",verifyingAuth:"\u6B63\u5728\u9A8C\u8BC1\u6388\u6743...",fetchingData:"\u83B7\u53D6\u6570\u636E\u4E2D...",savingData:"\u4FDD\u5B58\u6570\u636E\u4E2D...",downloadingCover:"\u4E0B\u8F7D\u5C01\u9762\u56FE\u7247...",savingCover:"\u4FDD\u5B58\u5C01\u9762\u56FE\u7247...",downloadingImages:"\u4E0B\u8F7D\u56FE\u7247\u4E2D...",settingNoteType:"\u8BBE\u7F6E\u7B14\u8BB0\u7C7B\u578B...",settingDataTime:"\u8BBE\u7F6E\u6570\u636E\u83B7\u53D6\u65F6\u95F4...",completed:"\u5B8C\u6210"},je={processingComplete:"\u5904\u7406\u5B8C\u6210\uFF01",success:"\u6210\u529F",recordsUpdated:"\u8BB0\u5F55\u66F4\u65B0",failedCount:"\u5931\u8D25\u6570\u91CF",skippedEmpty:"\u8DF3\u8FC7\u7A7A\u503C",attachmentRefreshHint:"\u5982\u679C\u9644\u4EF6\u6CA1\u6709\u663E\u793A\uFF0C\u8BF7\u5237\u65B0\u9875\u9762\u67E5\u770B\u3002",selectAtLeastOneField:"\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5B57\u6BB5",processingFailed:"\u5904\u7406\u5931\u8D25",pleaseLoginFirst:"\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743",refreshingUserInfo:"\u6B63\u5728\u5237\u65B0\u7528\u6237\u4FE1\u606F...",userInfoRefreshSuccess:"\u7528\u6237\u4FE1\u606F\u5237\u65B0\u6210\u529F",refreshFailed:"\u5237\u65B0\u5931\u8D25",authorizationExpired:"\u6388\u6743\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55",unknownError:"\u672A\u77E5\u9519\u8BEF",selectTableAndColumn:"\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868\u548C\u7B14\u8BB0\u94FE\u63A5\u5217",pleaseFillCookie:"\u8BF7\u586B\u5199Cookie\u4FE1\u606F",cannotGetViewInfo:"\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u89C6\u56FE\u4FE1\u606F\uFF0C\u8BF7\u786E\u4FDD\u5DF2\u9009\u62E9\u4E00\u4E2A\u89C6\u56FE",renew:"\u7EED\u8D39",activate:"\u5F00\u901A",todayDownload:"\u4ECA\u65E5\u4E0B\u8F7D",vipLevel:"VIP\u7B49\u7EA7",expireTime:"\u5230\u671F\u65F6\u95F4",refresh:"\u5237\u65B0",contactSupport:"\u8054\u7CFB\u6280\u672F\u652F\u6301",joinChatGroup:"\u4EA4\u6D41\u7FA4"},_e={title:"\u6E29\u99A8\u63D0\u793A",point1:"\u672C\u5DE5\u5177\u4EC5\u4F5C\u4E3A\u4E2A\u4EBA\u6570\u636E\u7BA1\u7406\u5DE5\u5177\uFF0C\u5E2E\u52A9\u7528\u6237\u6574\u7406\u548C\u7BA1\u7406\u5C0F\u7EA2\u4E66\u5E73\u53F0\u4E0A\u7684\u4E2A\u4EBA\u6536\u85CF\u4FE1\u606F",point2:"\u6240\u6709\u5185\u5BB9\u7684\u7248\u6743\u5F52\u539F\u4F5C\u8005\u53CA\u5C0F\u7EA2\u4E66\u5E73\u53F0\u6240\u6709\uFF0C\u672C\u5DE5\u5177\u4EC5\u63D0\u4F9B\u7D22\u5F15\u548C\u5BFC\u51FA\u529F\u80FD",point3:"\u7528\u6237\u5BFC\u51FA\u7684\u6570\u636E\u5E94\u4EC5\u7528\u4E8E\u4E2A\u4EBA\u5B66\u4E60\u3001\u7814\u7A76\u53CA\u5408\u6CD5\u5408\u89C4\u7684\u975E\u5546\u4E1A\u7528\u9014",point4:"\u53EF\u80FD\u4F1A\u6536\u53D6\u7EF4\u62A4\u8D39\u7528\uFF0C\u7528\u4E8E\u6301\u7EED\u6539\u8FDB\u548C\u4F18\u5316\u7528\u6237\u4F53\u9A8C",point5:"\u4F7F\u7528\u672C\u5DE5\u5177\u5373\u8868\u793A\u60A8\u5DF2\u9605\u8BFB\u5E76\u540C\u610F\u9075\u5B88\u5E73\u53F0\u670D\u52A1\u6761\u6B3E\uFF0C\u5BF9\u4F7F\u7528\u884C\u4E3A\u8D1F\u5168\u90E8\u8D23\u4EFB"},He={failed:"\u6388\u6743\u5931\u8D25",failedMessage:"\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458",tenantKey:"Tenant Key"},qe={normalUser:"\u666E\u901A\u7528\u6237",membershipExpired:"\u4F1A\u5458\u5DF2\u8FC7\u671F",processingPaused:"\u5DF2\u6682\u505C",initializing:"\u521D\u59CB\u5316...",fetchingRecord:"\u83B7\u53D6\u8BB0\u5F55\u4E2D...",requestingData:"\u8BF7\u6C42\u6570\u636E\u4E2D...",savingRecord:"\u4FDD\u5B58\u8BB0\u5F55\u6570\u636E...",settingCover:"\u8BBE\u7F6E\u5C01\u9762\u56FE\u7247...",settingImages:"\u8BBE\u7F6E\u56FE\u7247\u5217\u8868...",savingImages:"\u4FDD\u5B58\u56FE\u7247\u5217\u8868...",waitingUpload:"\u7B49\u5F85\u9644\u4EF6\u4E0A\u4F20...",verifyingCover:"\u9A8C\u8BC1\u5C01\u9762\u56FE\u7247...",verifyingImages:"\u9A8C\u8BC1\u56FE\u7247\u5217\u8868...",downloadImage:"\u4E0B\u8F7D\u56FE\u7247",readImageData:"\u8BFB\u53D6\u56FE\u7247\u6570\u636E",createImageFile:"\u521B\u5EFA\u56FE\u7247\u6587\u4EF6",retryDownload:"\u91CD\u8BD5\u4E0B\u8F7D\u56FE\u7247",imageDownloadProgress:"\u4E0B\u8F7D\u56FE\u7247",dataFetchFailed:"\u6570\u636E\u83B7\u53D6\u5931\u8D25",processingError:"\u5904\u7406\u9519\u8BEF",errorStatus:"\u9519\u8BEF",fieldCreateFailed:"\u90E8\u5206\u5B57\u6BB5\u521B\u5EFA\u5931\u8D25",fieldCreateFailedDetail:". \u8BF7\u68C0\u67E5\u8868\u683C\u6743\u9650\u6216\u5237\u65B0\u9875\u9762\u91CD\u8BD5\u3002",noRecordsSelected:"\u672A\u9009\u62E9\u4EFB\u4F55\u8BB0\u5F55\uFF0C\u5DF2\u53D6\u6D88\u5904\u7406",startProcessing:"\u5F00\u59CB\u5904\u7406",selectedRecords:"\u6761\u9009\u4E2D\u6570\u636E",selectRecords:"\u8BF7\u5728\u5F39\u51FA\u7684\u5BF9\u8BDD\u6846\u4E2D\u9009\u62E9\u8981\u5904\u7406\u7684\u8BB0\u5F55...",completed:"\u5B8C\u6210",link:"\u94FE\u63A5",text:"\u6587\u672C",second:"\u79D2"},Ke={title:Ne,subtitle:Re,form:Me,fields:Oe,noteTypes:ze,processing:Ve,messages:je,disclaimer:_e,auth:He,status:qe},Xe="Xiaohongshu Note Extractor",Ge="Batch collect Xiaohongshu note data and process image attachments",Je={selectTable:"Select Data Table",selectTablePlaceholder:"Please select a data table",selectColumn:"Select Note Link Column",selectColumnPlaceholder:"Please select a data table first",selectColumnHint:"Please select the column containing Xiaohongshu links or note IDs (text or link type)",selectFields:"Select Fields to Add",selectAll:"Select All",deselectAll:"Deselect All",cookieInput:"Cookie",cookieRequired:"Required field for fetching Xiaohongshu note data. Auto-saved after input for next visit",cookieLink:"Cookie Acquisition Guide",startProcessing:"Start Processing",pauseProcessing:"Pause Processing",resumeProcessing:"Resume Processing",requiredField:"Status Message (Required)",requiredFieldHint:"Used to display processing status, error messages or success messages"},We={noteId:"Xiaohongshu Link or Note ID",authorNickname:"Author Nickname",authorRedId:"Author Red ID",authorXhsUrl:"Author Homepage URL",authorFansCount:"Author Fans Count",authorDesc:"Author Description",title:"Note Title",description:"Note Content",noteType:"Note Type",publishTime:"Publish Time",coverUrl:"Cover Image",images:"Image List",videoUrl:"Video URL",videoDuration:"Video Duration",tags:"Topic List",likes:"Likes",collects:"Collections",shares:"Shares",comments:"Comments",ipLocation:"Post Location",dataFetchTime:"Data Fetch Time",errorMsg:"Status Message"},Qe={video:"Video Note",image:"Image Note",text:"Text Note"},Ye={processing:"Processing",processingProgress:"Processing Progress",verifyingAuth:"Verifying authorization...",fetchingData:"Fetching data...",savingData:"Saving data...",downloadingCover:"Downloading cover image...",savingCover:"Saving cover image...",downloadingImages:"Downloading images...",settingNoteType:"Setting note type...",settingDataTime:"Setting data fetch time...",completed:"Completed"},Ze={processingComplete:"Processing Complete!",success:"Success",recordsUpdated:"Records Updated",failedCount:"Failed Count",skippedEmpty:"Skipped Empty",attachmentRefreshHint:"If attachments are not showing, please refresh the page to view.",selectAtLeastOneField:"Please select at least one field",processingFailed:"Processing Failed",pleaseLoginFirst:"Please re-login to get authorization",refreshingUserInfo:"Refreshing user information...",userInfoRefreshSuccess:"User information refreshed successfully",refreshFailed:"Refresh Failed",authorizationExpired:"Authorization has expired, please re-login",unknownError:"Unknown Error",selectTableAndColumn:"Please select a data table and note link column first",pleaseFillCookie:"Please fill in Cookie information",cannotGetViewInfo:"Unable to get current view information, please ensure a view is selected",renew:"Renew",activate:"Activate",todayDownload:"Today's Downloads",vipLevel:"VIP Level",expireTime:"Expire Time",refresh:"Refresh",contactSupport:"Contact Support",joinChatGroup:"Join Chat Group"},et={title:"Friendly Reminder",point1:"This tool is only for personal data management, helping users organize and manage personal collections on the Xiaohongshu platform",point2:"All content rights belong to the original authors and Xiaohongshu platform. This tool only provides indexing and export functions",point3:"Exported data should only be used for personal learning, research and legal, compliant non-commercial purposes",point4:"Maintenance fees may be charged for continuous improvement and optimization of user experience",point5:"Using this tool indicates that you have read and agree to comply with the platform's terms of service and are fully responsible for your usage"},tt={failed:"Authorization Failed",failedMessage:"Unable to verify your authorization information. Please provide the following information to the administrator",tenantKey:"Tenant Key"},ot={normalUser:"Normal User",membershipExpired:"Membership Expired",processingPaused:"Paused",initializing:"Initializing...",fetchingRecord:"Fetching record...",requestingData:"Requesting data...",savingRecord:"Saving record data...",settingCover:"Setting cover image...",settingImages:"Setting image list...",savingImages:"Saving image list...",waitingUpload:"Waiting for upload...",verifyingCover:"Verifying cover image...",verifyingImages:"Verifying image list...",downloadImage:"Download image",readImageData:"Read image data",createImageFile:"Create image file",retryDownload:"Retry download",imageDownloadProgress:"Downloading image",dataFetchFailed:"Data fetch failed",processingError:"Processing error",errorStatus:"Error",fieldCreateFailed:"Some fields failed to create",fieldCreateFailedDetail:". Please check table permissions or refresh page and retry.",noRecordsSelected:"No records selected, processing cancelled",startProcessing:"Start processing",selectedRecords:"selected records",selectRecords:"Please select the records to process in the dialog...",completed:"Completed",link:"Link",text:"Text",second:"s"},st={title:Xe,subtitle:Ge,form:Je,fields:We,noteTypes:Qe,processing:Ye,messages:Ze,disclaimer:et,auth:tt,status:ot};i.use(Ue).init({resources:{zh:{translation:Ke},en:{translation:st}},fallbackLng:"zh",debug:!1,interpolation:{escapeValue:!1}}).then(()=>{Pe.init(i,t,{tName:"t",i18nName:"i18n",handleName:"localize",selectorAttr:"data-i18n",targetAttr:"i18n-target",optionsAttr:"i18n-options",parseOptionsFromContent:!0}),te()});function te(){t("[data-i18n]").localize(),document.title=i.t("title"),document.documentElement.lang=i.language}function $(e,o="processing"){const n=document.getElementById("status");n&&(n.textContent=e,n.className=`status ${o}`,n.style.display="block",(o==="success"||o==="error")&&setTimeout(()=>{n.style.display="none"},3e3))}function B(e,o,n){const l=`[${e}/${o}] ${n}`;t("#processColumn").text(l);const s=Math.round(e/o*100),a=t("#progressContainer"),d=t("#progressBar"),h=t("#progressText"),C=t("#progressPercent");if(a.length===0){console.error("Progress container not found!");return}if(d.length===0){console.error("Progress bar not found!");return}a.show().addClass("show"),d.css("width",`${s}%`),d[0]&&(d[0].style.width=`${s}%`,d[0].style.minWidth="2px"),d.attr("style",`height: 100%; background: linear-gradient(90deg, #ff2442 0%, #ff6b6b 100%); width: ${s}%; border-radius: 4px; transition: width 0.3s ease; position: relative; min-width: 2px !important;`),h.text(n),C.text(`${s}%`),d[0].offsetHeight}function xe(){const e=t("#progressContainer");e.removeClass("show"),setTimeout(()=>{e.hide()},300)}function it(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="visible",e.style.opacity="1")}function nt(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="hidden",e.style.opacity="0")}async function rt(){try{const e=await L.bridge.getTenantKey(),o=await L.bridge.getBaseUserId();if(!e||!o)return console.error("Missing tenant key or user ID"),{success:!1};const n=new FormData;n.append("tenantKey",e),n.append("userId",o);const l=await fetch("https://shop.leshangyundian.com/feishu/user/login",{method:"POST",body:n});if(l.ok){const s=await l.json();return s.success===!0&&s.data?(at(s.data.token),oe(s.data),Q(s.data),{success:!0,data:s.data}):{success:!1}}else return console.error("Authorization failed:",l.status,l.statusText),{success:!1}}catch(e){return console.error("Authorization error:",e),{success:!1}}}function at(e){localStorage.setItem("xhsnote_token",e)}function J(){return localStorage.getItem("xhsnote_token")}function oe(e){localStorage.setItem("xhsnote_user_info",JSON.stringify(e))}function Ie(){const e=localStorage.getItem("xhsnote_user_info");if(e)try{return JSON.parse(e)}catch(o){console.error("Failed to parse saved user info:",o)}return null}function Q(e){t("#userName").text(e.userName||""),e.vipLevelName?(t("#vipLevelName").text(e.vipLevelName),t("#vipLevelName").css("color","#ff2442")):(t("#vipLevelName").text(i.t("messages.normalUser")),t("#vipLevelName").css("color","#666"));let o=!1;const n=new Date;if(e.vipExpire&&e.vipLevel>0){const l=new Date(e.vipExpire),s=l.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});o=l<n,t("#vipExpireTime").text(s),t("#vipExpireInfo").show(),o&&(t("#vipExpireInfo").find("span").eq(0).text(i.t("messages.membershipExpired")),t("#vipExpireTime").css("color","#ff6b6b"))}else e.vipLevel===0?t("#vipExpireInfo").hide():t("#vipExpireInfo").hide();e.todayDownloadCount!==void 0?t("#todayDownloadCount").text(e.todayDownloadCount):t("#todayDownloadCount").text("0"),e.maxDailyDownloads!==void 0?t("#maxDailyDownloads").text(e.maxDailyDownloads):t("#maxDailyDownloads").text("--"),e.vipLevel===0||o?(t("#rechargeBtn").show(),o?(t("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u7EED\u8D39
      `),t("#vipLevelName").css("color","#ff6b6b")):t("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u5F00\u901A
      `)):t("#rechargeBtn").hide(),o&&$(i.t("messages.membershipExpired"),"error"),t("#userInfo").show()}function lt(e){localStorage.setItem("xhsnote_cookies",e)}function ct(){return localStorage.getItem("xhsnote_cookies")}function dt(){localStorage.removeItem("xhsnote_token"),localStorage.removeItem("xhsnote_user_info"),localStorage.removeItem("xhsnote_cookies")}function ut(e){if(!e)return[];const o=[],n=/#([^#\[\]]+)\[话题\]#/g;let l;for(;(l=n.exec(e))!==null;)o.push(l[1]);return o}function W(e){if(!e||typeof e!="string")return 0;const o=e.trim();if(/^\d+$/.test(o))return parseInt(o,10);const n=[/^([\d.]+)万/,/^(\d+)千\+?$/,/^([\d.]+)千$/,/^([\d.]+)k/,/^(\d+)$/];for(const l of n){const s=o.match(l);if(s){const a=parseFloat(s[1]);if(l===n[0])return Math.round(a*1e4);if(l===n[1]||l===n[2])return Math.round(a*1e3);if(l===n[3])return Math.round(a*1e3);if(l===n[4])return parseInt(String(a),10)}}return console.warn(`\u65E0\u6CD5\u89E3\u6790\u6570\u5B57\u683C\u5F0F: ${e}`),0}function gt(e){localStorage.setItem("xhsnote_selected_fields",JSON.stringify(e))}function pt(){const e=localStorage.getItem("xhsnote_selected_fields");if(e)try{return JSON.parse(e)}catch(o){console.error("Failed to parse saved field selection:",o)}return["noteId","authorNickname","authorRedId","authorXhsUrl","authorFansCount","authorDesc","title","description","dataFetchTime","coverUrl","images"]}const Ee={noteId:{label:"\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID",type:y.Text},authorNickname:{label:"\u535A\u4E3B\u6635\u79F0",type:y.Text},authorRedId:{label:"\u535A\u4E3B\u5C0F\u7EA2\u4E66\u53F7",type:y.Text},authorXhsUrl:{label:"\u535A\u4E3B\u4E3B\u9875\u94FE\u63A5",type:y.Url},authorFansCount:{label:"\u535A\u4E3B\u7C89\u4E1D\u6570",type:y.Number},authorDesc:{label:"\u535A\u4E3B\u7B80\u4ECB",type:y.Text},title:{label:"\u7B14\u8BB0\u6807\u9898",type:y.Text},description:{label:"\u7B14\u8BB0\u5185\u5BB9",type:y.Text},noteType:{label:"\u7B14\u8BB0\u7C7B\u578B",type:y.SingleSelect},publishTime:{label:"\u53D1\u5E03\u65F6\u95F4",type:y.Text},coverUrl:{label:"\u5C01\u9762\u56FE",type:y.Attachment},images:{label:"\u56FE\u7247\u5217\u8868",type:y.Attachment},videoUrl:{label:"\u89C6\u9891\u5730\u5740",type:y.Url},videoDuration:{label:"\u89C6\u9891\u65F6\u957F",type:y.Text},tags:{label:"\u8BDD\u9898\u5217\u8868",type:y.MultiSelect},likes:{label:"\u70B9\u8D5E\u6570",type:y.Number},collects:{label:"\u6536\u85CF\u6570",type:y.Number},shares:{label:"\u8F6C\u53D1\u6570",type:y.Number},comments:{label:"\u8BC4\u8BBA\u6570",type:y.Number},ipLocation:{label:"\u53D1\u6587\u5730\u5740",type:y.Text},dataFetchTime:{label:"\u6570\u636E\u83B7\u53D6\u65F6\u95F4",type:y.DateTime},errorMsg:{label:"\u63D0\u793A\u4FE1\u606F",type:y.Text}};function Ce(){const e=[];if(t('input[name="fields"]:checked').each(function(){const o=t(this).val(),n=Ee[o];n&&e.push({name:o,label:n.label,type:n.type})}),!e.some(o=>o.name==="errorMsg")){const o=Ee.errorMsg;o&&e.push({name:"errorMsg",label:o.label,type:o.type})}return e}async function ft(e,o,n){try{let s=(await e.getFieldMetaList()).find(d=>d.name===o);if(s)return s.type!==n,s.id;const a=await e.addField({type:n,name:o});if(o==="\u7B14\u8BB0\u7C7B\u578B"&&n===y.SingleSelect)try{await(await e.getField(a)).addOptions([{name:"\u89C6\u9891\u7B14\u8BB0"},{name:"\u56FE\u6587\u7B14\u8BB0"},{name:"\u6587\u672C\u7B14\u8BB0"}])}catch(d){console.error("Failed to add options for noteType field:",d)}return a}catch(l){return console.error(`Error creating field "${o}":`,l),""}}async function ht(e,o){try{return(await e.getFieldMetaList()).some(l=>l.id===o)}catch(n){return console.error(`Field validation error for ID ${o}:`,n),!1}}async function mt(e){const o=new Map,n=Ce();if(n.length===0)return $(i.t("messages.selectAtLeastOneField"),"error"),o;const l=await e.getFieldMetaList();for(const a of l){const d=n.find(h=>h.label===a.name);if(d&&a.type!==d.type)try{await e.deleteField(a.id)}catch(h){console.error(`Failed to delete field ${a.name}:`,h)}}await e.getFieldMetaList();for(const a of n)try{const h=await ft(e,a.label,a.type)||"";h?(await ht(e,h)||console.error(`Field ${a.name} failed validation`),o.set(a.name,h)):console.error(`Failed to get ID for field ${a.name}`)}catch(d){console.error(`Failed to create field ${a.label}:`,d)}return n.some(a=>a.name==="tags")&&await yt(e,o.get("tags")),o}async function yt(e,o){if(!!o)try{const n=await e.getRecordIdList(),l=t("#columnSelect").val(),s=new Set;if(!(await e.getRecordById(n[0])).fields[l])return;for(let h=0;h<Math.min(n.length,100);h++){const C=n[h];try{const u=(await e.getRecordById(C)).fields[l];u&&u.text&&ut(u.text).forEach(F=>s.add(F))}catch(r){console.error(`Error scanning record ${h}:`,r)}}s.size>0&&await(await e.getField(o)).addOptions(Array.from(s).map(C=>({name:C})))}catch(n){console.error("Error collecting topics:",n)}}async function Ft(e){try{let o=e;e.startsWith("http://")&&(o=e.replace("http://","https://"));const n=await fetch(o,{mode:"cors"});if(!n.ok)return[];const l=await n.blob(),s=`cover_${Date.now()}.${l.type.split("/")[1]||"jpg"}`;return[new File([l],s,{type:l.type})]}catch(o){return console.error("Error processing image URL:",o),console.warn("CORS or download error. Image will be skipped."),[]}}async function wt(e,o,n,l=3,s){let a=e;e.startsWith("http://")&&(a=e.replace("http://","https://"));let d=null;for(let h=1;h<=l;h++)try{s&&s(`${i.t("status.downloadImage")} ${o+1}/${n} (${i.t("status.retryDownload")} ${h}/${l})`);const C=await fetch(a,{mode:"cors",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}});if(!C.ok)throw new Error(`HTTP ${C.status}: ${C.statusText}`);s&&s(`${i.t("status.readImageData")} ${o+1}/${n}`);const r=await C.blob();if(r.size===0)throw new Error("Downloaded file is empty");s&&s(`${i.t("status.createImageFile")} ${o+1}/${n}`);const u=`image_${String(o+1).padStart(3,"0")}_${Date.now()}.${r.type.split("/")[1]||"jpg"}`;return new File([r],u,{type:r.type})}catch(C){if(d=C,console.warn(`\u274C Attempt ${h}/${l} failed for image ${o+1}:`,C instanceof Error?C.message:String(C)),h<l){const r=h*1e3;s&&s(`${i.t("status.retryDownload")} ${i.t("status.imageDownloadProgress")} ${o+1}/${n} (${i.t("status.retryDownload")} after ${r}ms)`),await new Promise(u=>setTimeout(u,r))}}return console.error(`\u{1F4A5} All attempts failed for image ${o+1}:`,d),null}async function vt(e,o){if(!e||e.length===0)return[];const n=[],l=3;for(let s=0;s<e.length;s++){const a=e[s];o&&o(s+1,e.length,`${i.t("status.imageDownloadProgress")} ${s+1}/${e.length}`);try{const d=await wt(a,s,e.length,l,h=>{o&&o(s+1,e.length,h)});d?n.push(d):console.warn(`\u26A0\uFE0F Skipped image ${s+1} due to download failure`)}catch(d){console.error(`\u{1F4A5} Unexpected error processing image ${s+1}:`,d)}s<e.length-1&&await new Promise(d=>setTimeout(d,200))}if(n.length<e.length){const s=e.length-n.length;console.warn(`\u26A0\uFE0F ${s} images failed to download and will be skipped`)}return n}async function ke(e){try{const n=await(await L.base.getTableById(e)).getFieldMetaList();if(t("#columnSelect").empty(),n&&n.length>0){const l=n.filter(s=>s.type===y.Text||s.type===y.Url);if(l.length>0){const s=l.map(a=>{const d=a.type===y.Url?i.t("status.link"):i.t("status.text");return`<option value="${a.id}">${a.name} (${d})</option>`}).join("");t("#columnSelect").append('<option value="">\u8BF7\u9009\u62E9\u7B14\u8BB0\u94FE\u63A5\u5217</option>'),t("#columnSelect").append(s)}else t("#columnSelect").append('<option value="">\u672A\u627E\u5230\u53EF\u7528\u7684\u7B14\u8BB0\u94FE\u63A5\u5217</option>')}else t("#columnSelect").append('<option value="">\u6CA1\u6709\u53EF\u7528\u7684\u5217</option>')}catch(o){console.error("Error loading columns:",o),t("#columnSelect").empty().append('<option value="">\u52A0\u8F7D\u5217\u5931\u8D25</option>')}}t(document).ready(async function(){window.addEventListener("error",function(r){console.error("Uncaught error:",r.error)}),window.addEventListener("unhandledrejection",function(r){console.error("Unhandled promise rejection:",r.reason)});let e=!1,o=!1;try{if(typeof L>"u")console.error("Bitable API not available"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3);else try{const r=await L.bridge.getEnv();(!r.product||r.product!=="feishu"&&r.product!=="lark")&&(console.error("Not in Feishu or Lark environment"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3))}catch(r){console.warn("Environment check failed, but continuing:",r)}}catch(r){console.error("Environment check encountered error:",r)}const n=Ie();if(n&&Q(n),it(),!(await rt()).success){let r="",u="";try{const F=await L.bridge.getTenantKey(),A=await L.bridge.getBaseUserId();r=F||"\u65E0\u6CD5\u83B7\u53D6",u=A||"\u65E0\u6CD5\u83B7\u53D6"}catch(F){console.error("Failed to get debug info:",F)}const T="https://shop.leshangyundian.com/feishu/user/login";t("body").html(`
      <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #ffeef2 0%, #ffe4e8 100%);">
        <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 107, 107, 0.2); max-width: 700px;">
          <div style="font-size: 64px; margin-bottom: 20px;">\u{1F614}</div>
          <h1 style="color: #ff2442; margin-bottom: 16px;">\u6388\u6743\u5931\u8D25</h1>
          <p style="color: #666; margin-bottom: 24px;">\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458</p>

          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <p style="margin: 0 0 10px 0;"><strong>Tenant Key:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${r}</code>

            <p style="margin: 20px 0 10px 0;"><strong>Base User ID:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${u}</code>
      </div>

          <button onclick="location.reload()" style="padding: 12px 32px; background: linear-gradient(135deg, #ff2442 0%, #ff6b6b 100%); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; transition: transform 0.2s; margin-right: 12px;">
            \u91CD\u65B0\u52A0\u8F7D
          </button>
          <button onclick="navigator.clipboard.writeText('Tenant Key: ${r}\\nBase User ID: ${u}\\nURL: ${T}\\nFormData: tenantKey=${r}&userId=${u}')" style="padding: 12px 32px; background: white; color: #ff2442; border: 2px solid #ff2442; border-radius: 12px; font-size: 16px; cursor: pointer; transition: all 0.2s;">
            \u590D\u5236\u4FE1\u606F
          </button>
        </div>
      </div>
    `);return}nt();const s=pt();t('input[name="fields"]').each(function(){const r=t(this).val();r==="errorMsg"?t(this).prop("checked",!0):t(this).prop("checked",s.includes(r))});const a=ct();a&&t("#cookieInput").val(a);try{if(!L.base)throw console.error("bitable.base is undefined"),new Error("bitable.base is not available");const r=await L.base.getTableMetaList(),u=await L.base.getSelection();if(t("#tableSelect").empty(),r&&r.length>0){const T=r.map(F=>`<option value="${F.id}">${F.name}</option>`).join("");t("#tableSelect").append(T),u&&u.tableId&&(t("#tableSelect").val(u.tableId),await ke(u.tableId))}else t("#tableSelect").append('<option value="">No tables available</option>')}catch(r){console.error("Error loading tables:",r),t("#tableSelect").append('<option value="">Error loading tables</option>')}t("#tableSelect").on("change",async function(){const r=t(this).val();r?await ke(r):t("#columnSelect").empty().append('<option value="">\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868</option>')}),t("#processColumn").on("click",async function(){try{const r=t("#tableSelect").val(),u=t("#columnSelect").val(),T=J();if(!r||!u){$(i.t("messages.selectTableAndColumn"),"error");return}if(!T){$("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}if(!(t("#cookieInput").val()||"").trim()){$(i.t("messages.pleaseFillCookie"),"error"),t("#cookieInput").focus();return}const A=await L.base.getSelection();if(!A||!A.viewId){$(i.t("messages.cannotGetViewInfo"),"error");return}$(i.t("status.selectRecords"),"processing");const w=await L.ui.selectRecordIdList(r,A.viewId);if(!w||w.length===0){$(i.t("status.noRecordsSelected"),"error");return}e=!0,o=!1,t("#processColumn").prop("disabled",!0),t("#pauseProcess").show(),B(0,w.length,i.t("status.initializing")),$(`${i.t("status.startProcessing")} ${w.length} ${i.t("status.selectedRecords")}...`,"processing");const De=await L.bridge.getBaseUserId(),Te=await L.bridge.getInstanceId(),D=await L.base.getTableById(r),m=await mt(D),Y=Ce().filter(p=>!m.get(p.name));if(Y.length>0){console.error(`Missing selected fields: ${Y.map(p=>p.name).join(", ")}`),$(`${i.t("status.fieldCreateFailed")}: ${Y.map(p=>p.label).join(", ")}${i.t("status.fieldCreateFailedDetail")}`,"error");return}let V=0,z=0,se=0;for(let p=0;p<w.length&&e;p++){const b=w[p];try{for(;o&&e;)B(p,w.length,i.t("status.processingPaused")),await new Promise(S=>setTimeout(S,1e3));if(!e)break;if(p>0){const S=Math.floor(Math.random()*201)+800;await new Promise(c=>setTimeout(c,S))}B(p,w.length,i.t("status.fetchingRecord"));const E=(await D.getRecordById(b)).fields[u];if(B(p,w.length,i.t("status.requestingData")),!E||Array.isArray(E)&&E.length===0)continue;let P="";if(Array.isArray(E)){let S=!1;for(let c=0;c<E.length;c++){const x=E[c];if(x&&typeof x=="object"&&x.type==="url"&&x.link){P=x.link,S=!0;break}}if(!S&&E.length>0){const c=E[0];c&&typeof c=="object"&&c.text&&(P=c.text)}}else typeof E=="string"?P=E:E&&typeof E=="object"&&("link"in E&&E.link?P=E.link:"text"in E&&E.text&&(P=E.text));if(!P)continue;const j=t("#cookieInput").val()||"";B(p,w.length,i.t("processing.fetchingData"));const U=await fetch("https://shop.leshangyundian.com/feishu/user/vip/xhs/note",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`},body:JSON.stringify({url:P,cookies:j,userId:De,instanceId:Te})});if(U.ok){const S=await U.json();if(S&&S.success===!0){V++;const c=S.data||S;let x="";c.videoUrl?x=i.t("noteTypes.video"):c.imageList&&c.imageList.length>0?x=i.t("noteTypes.image"):x=i.t("noteTypes.text"),B(p,w.length,i.t("processing.savingData"));const k={},O=m.get("noteId");O&&(k[O]=P);const ne=m.get("errorMsg");ne&&(k[ne]="");const re=m.get("authorNickname");if(re){const g=c.authorNickname||c.user&&(c.user.name||c.user.nickname)||"";k[re]=g}const ae=m.get("authorRedId");ae&&(k[ae]=c.authorRedId||"");const le=m.get("authorXhsUrl");le&&(k[le]=c.authorXhsUrl||"");const ce=m.get("authorFansCount");if(ce){const g=c.authorFansCount&&parseInt(c.authorFansCount)||0;k[ce]=g}const de=m.get("authorDesc");de&&(k[de]=c.authorDesc||"");const ue=m.get("title");ue&&(k[ue]=c.title||"");const ge=m.get("description");ge&&(k[ge]=c.desc||"");const _=m.get("noteType");let H=null;if(_&&x)try{const g=await D.getField(_),I=await g.getOptions();if(I.map(v=>v.name).includes(x)){const v=I.find(R=>R.name===x);v&&(H=v.id)}else{await g.addOptions([{name:x}]);const R=(await g.getOptions()).find(be=>be.name===x);R&&(H=R.id)}}catch(g){console.error("Failed to handle noteType field:",g)}const pe=m.get("publishTime");pe&&(k[pe]=c.createTimeStr||"");const q=m.get("dataFetchTime");let K=null;q&&(K=Date.now());let X=[],G=[];if(c.imageList&&c.imageList.length>0){const g=c.imageList[0].imageUrl||c.imageList[0].url||"";g&&(X=await Ft(g),X.length>0);const I=c.imageList.map(f=>f.imageUrl||f.url).filter(f=>f);I.length>0&&(G=await vt(I,(f,v,R)=>{B(p,w.length,R)}),G.length>0)}const fe=m.get("videoUrl");fe&&(k[fe]=c.videoUrl||"");const he=m.get("videoDuration");he&&(k[he]=c.videoDuration?`${c.videoDuration}${i.t("status.second")}`:"");const Z=m.get("tags");if(Z){let g=[];c.tags&&(g=c.tags.split(",").map(I=>I.trim()).filter(I=>I));try{const I=await D.getField(Z),f=await I.getOptions();if(g.length>0){const v=f.map(M=>M.name),R=g.filter(M=>!v.includes(M));R.length>0&&await I.addOptions(R.map(M=>({name:M})));const Le=(await I.getOptions()).filter(M=>g.includes(M.name)).map(M=>M.id);await I.setValue(b,Le)}else await I.setValue(b,[])}catch(I){console.error("Error handling multi-select field:",I),k[Z]=[]}}const me=m.get("likes");if(me){const g=W(String(c.likedCount));k[me]=g}const ye=m.get("collects");if(ye){const g=W(String(c.collectedCount));k[ye]=g}const Fe=m.get("shares");if(Fe){const g=W(String(c.sharedCount));k[Fe]=g}const we=m.get("comments");if(we){const g=W(String(c.commentsCount));k[we]=g}const ve=m.get("ipLocation");ve&&(k[ve]=c.ipLocation||"");const Be=await D.getFieldMetaList(),ee={};for(const[g,I]of Object.entries(k))Be.find(v=>v.id===g)?ee[g]=I:console.warn(`Field ID ${g} no longer exists, skipping...`);if(Object.keys(ee).length>0){if(B(p,w.length,i.t("status.savingRecord")),await D.setRecord(b,{fields:ee}),se++,X.length>0){const f=m.get("coverUrl");if(f)try{B(p,w.length,"\u8BBE\u7F6E\u5C01\u9762\u56FE\u7247...");const v=await D.getField(f);v?(B(p,w.length,i.t("processing.savingCover")),await v.setValue(b,X)):console.error("Could not get cover field object")}catch(v){console.error("Error setting cover attachments:",v)}}if(G.length>0){const f=m.get("images");if(f)try{B(p,w.length,"\u8BBE\u7F6E\u56FE\u7247\u5217\u8868...");const v=await D.getField(f);v?(B(p,w.length,"\u4FDD\u5B58\u56FE\u7247\u5217\u8868..."),await v.setValue(b,G)):console.error("Could not get images field object")}catch(v){console.error("Error setting image attachments:",v)}}B(p+1,w.length,i.t("status.waitingUpload")),await new Promise(f=>setTimeout(f,3e3));const g=m.get("coverUrl");if(g)try{if(B(p+1,w.length,i.t("status.verifyingCover")),await D.getField(g)){const v=await D.getCellValue(g,b)}}catch(f){console.error("Error getting cover field URLs:",f)}const I=m.get("images");if(I)try{if(B(p+1,w.length,i.t("status.verifyingImages")),await D.getField(I)){const v=await D.getCellValue(I,b)}}catch(f){console.error("Error getting images field URLs:",f)}if(_&&H)try{B(p,w.length,i.t("processing.settingNoteType")),await(await D.getField(_)).setValue(b,H)}catch(f){console.error("Error setting note type value:",f)}if(q&&K!==null)try{B(p,w.length,i.t("processing.settingDataTime"));const f=await D.getField(q);await f.setDateFormat(Ae.DATE_TIME),await f.setValue(b,K)}catch(f){console.error("Error setting data fetch time value:",f);try{await(await D.getField(q)).setValue(b,K)}catch(v){console.error("Error setting data fetch time value without format:",v)}}}else console.warn(`No valid fields to update for record ${b}`)}else{z++;const c=S.msg||S.message||i.t("status.dataFetchFailed"),x=m.get("errorMsg");if(x)try{await D.setRecord(b,{fields:{[x]:c}})}catch(k){console.error(`Failed to save error message for record ${b}:`,k)}}}else{let S=U.statusText;try{const x=await U.json();S=JSON.stringify(x)}catch{S=await U.text()}console.error(`Failed to process record ${p+1}:`,U.status,S),z++;const c=m.get("errorMsg");if(c){const x={};if(x[c]=`${i.t("status.errorStatus")} ${U.status}: ${S}`,(await D.getFieldMetaList()).find(O=>O.id===c))try{await D.setRecord(b,{fields:x})}catch(O){console.error(`Failed to save error message for record ${b}:`,O)}}}}catch(N){console.error(`Error processing record ${p+1}:`,N),z++;const E=m.get("errorMsg");if(E){const P={};P[E]=`${i.t("status.processingError")}: ${N instanceof Error?N.message:String(N)}`;try{if((await D.getFieldMetaList()).find(U=>U.id===E))try{await D.setRecord(b,{fields:P})}catch(U){console.error(`Failed to save error message for record ${b}:`,U)}}catch(j){console.error("Failed to validate field for error message:",j)}}}}e=!1,B(w.length,w.length,i.t("status.completed")),t("#processColumn").prop("disabled",!1).text(i.t("form.startProcessing")),t("#pauseProcess").hide(),setTimeout(()=>{xe()},2e3);const $e=V+z,Se=w.length-$e,ie=`${i.t("messages.processingComplete")}
${i.t("messages.success")}: ${V}
${i.t("messages.recordsUpdated")}: ${se}
${i.t("messages.failedCount")}: ${z}
${i.t("messages.skippedEmpty")}: ${Se}

${i.t("messages.attachmentRefreshHint")}`;if($(ie,ie.includes(i.t("messages.processingComplete"))?"success":"error"),V>0){const p=J();if(p)try{const b=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`}});if(b.ok){const N=await b.json();N.success===!0&&N.data&&(oe(N.data),Q(N.data))}}catch(b){console.error("Failed to refresh user info after processing:",b)}}}catch(r){console.error("Error processing column:",r),$(i.t("messages.processingFailed")+": "+(r instanceof Error?r.message:String(r)),"error"),e=!1,t("#processColumn").prop("disabled",!1).text(i.t("form.startProcessing")),t("#pauseProcess").hide(),xe()}}),t("#pauseProcess").on("click",function(){o=!o,t(this).text(o?i.t("form.resumeProcessing"):i.t("form.pauseProcessing"))}),t("#refreshUserInfo").on("click",async function(){const r=J();if(!r){$("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}const u=t(this),T=u.find("svg");u.prop("disabled",!0),T.css("animation","spin 1s linear infinite");try{$(i.t("messages.refreshingUserInfo"),"processing");const F=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(F.ok){const A=await F.json();A.success===!0&&A.data?(oe(A.data),Q(A.data),$(i.t("messages.userInfoRefreshSuccess"),"success")):($(i.t("messages.refreshFailed")+": "+(A.message||i.t("messages.unknownError")),"error"),F.status===401&&(dt(),$(i.t("messages.authorizationExpired"),"error")))}else throw new Error(`HTTP ${F.status}: ${F.statusText}`)}catch(F){console.error("Refresh user info error:",F),$("\u5237\u65B0\u5931\u8D25\uFF1A"+(F instanceof Error?F.message:String(F)),"error")}finally{u.prop("disabled",!1),T.css("animation","")}}),t("#rechargeBtn").on("click",function(){const r=J(),u=Ie();if(u&&u.userId&&r){const T=`https://shop.leshangyundian.com/payment?id=${u.userId}&token=${r}&type=NOTE_VIP`;window.open(T,"_blank")}else $("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error")}),t("#selectAllFields").on("click",function(){t('input[name="fields"]:not(:disabled)').prop("checked",!0),d()}),t("#deselectAllFields").on("click",function(){t('input[name="fields"]:not(:disabled)').each(function(){t(this).prop("checked",!t(this).prop("checked"))}),d()}),t('input[name="fields"]').on("change",d),t("#cookieInput").on("input blur",function(){const r=t(this).val();r&&r.trim()&&lt(r.trim())});function d(){const r=[];t('input[name="fields"]:checked').each(function(){const u=t(this).val();r.push(u)}),gt(r)}t("#languageToggle").on("click",function(){const u=i.language==="zh"?"en":"zh";i.changeLanguage(u,(T,F)=>{if(T)return console.error("Failed to change language:",T);te(),t("#currentLanguage").text(u==="zh"?"\u4E2D\u6587":"English"),h(),localStorage.setItem("preferred_language",u)})});function h(){t('input[name="fields"]').each(function(){const r=t(this).val(),u=t(this).siblings("span").last();if(u&&u.text()){const T=`fields.${r}`,F=i.t(T);F&&F!==T&&u.text(F)}})}const C=localStorage.getItem("preferred_language");C&&["zh","en"].includes(C)&&i.changeLanguage(C,(r,u)=>{if(r)return console.error("Failed to restore language:",r);te(),h(),t("#currentLanguage").text(C==="zh"?"\u4E2D\u6587":"English")})});

import{H as y,p as L,q as Pe}from"./vendor-lark.6ef72961.js";import{j as Ue,$ as o}from"./vendor-jquery.88f4ff12.js";import{i as n,B as Ne}from"./vendor-i18n.7cd67a60.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))l(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&l(u)}).observe(document,{childList:!0,subtree:!0});function i(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerpolicy&&(a.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?a.credentials="include":s.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function l(s){if(s.ep)return;s.ep=!0;const a=i(s);fetch(s.href,a)}})();const Re="\u5C0F\u7EA2\u4E66\u7B14\u8BB0\u63D0\u53D6",Me="\u6279\u91CF\u91C7\u96C6\u5C0F\u7EA2\u4E66\u7B14\u8BB0\u6570\u636E\u5E76\u5904\u7406\u56FE\u7247\u9644\u4EF6",Oe={selectTable:"\u9009\u62E9\u6570\u636E\u8868",selectTablePlaceholder:"\u8BF7\u9009\u62E9\u6570\u636E\u8868",selectColumn:"\u9009\u62E9\u7B14\u8BB0\u94FE\u63A5\u5217",selectColumnPlaceholder:"\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868",selectColumnHint:"\u8BF7\u9009\u62E9\u5305\u542B\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID\u7684\u5217\uFF08\u6587\u672C\u6216\u94FE\u63A5\u7C7B\u578B\uFF09",selectFields:"\u9009\u62E9\u8981\u6DFB\u52A0\u7684\u5B57\u6BB5",selectAll:"\u5168\u9009",deselectAll:"\u53CD\u9009",cookieInput:"Cookie",cookieRequired:"\u5FC5\u586B\u9879\uFF0C\u7528\u4E8E\u5C0F\u7EA2\u4E66\u7B14\u8BB0\u6570\u636E\u6293\u53D6",cookieSaved:"\u2705 Cookie\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\uFF0C\u4E0B\u6B21\u5C06\u81EA\u52A8\u586B\u5145",cookieExpired:"\u26A0\uFE0F \u672C\u5730\u4FDD\u5B58\u7684Cookie\u5DF2\u8FC7\u671F\uFF08\u8D85\u8FC730\u5929\uFF09\uFF0C\u8BF7\u91CD\u65B0\u8F93\u5165",cookieLink:"Cookie\u83B7\u53D6\u65B9\u6CD5",startProcessing:"\u5F00\u59CB\u5904\u7406",pauseProcessing:"\u6682\u505C\u5904\u7406",resumeProcessing:"\u7EE7\u7EED\u5904\u7406",requiredField:"\u63D0\u793A\u4FE1\u606F\uFF08\u5FC5\u9009\uFF09",requiredFieldHint:"\u7528\u4E8E\u663E\u793A\u5904\u7406\u72B6\u6001\u3001\u9519\u8BEF\u4FE1\u606F\u6216\u6210\u529F\u6D88\u606F"},ze={noteId:"\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID",authorNickname:"\u535A\u4E3B\u6635\u79F0",authorRedId:"\u535A\u4E3B\u5C0F\u7EA2\u4E66\u53F7",authorXhsUrl:"\u535A\u4E3B\u4E3B\u9875\u94FE\u63A5",authorFansCount:"\u535A\u4E3B\u7C89\u4E1D\u6570",authorDesc:"\u535A\u4E3B\u7B80\u4ECB",title:"\u7B14\u8BB0\u6807\u9898",description:"\u7B14\u8BB0\u5185\u5BB9",noteType:"\u7B14\u8BB0\u7C7B\u578B",publishTime:"\u53D1\u5E03\u65F6\u95F4",coverUrl:"\u5C01\u9762\u56FE",images:"\u56FE\u7247\u5217\u8868",videoUrl:"\u89C6\u9891\u5730\u5740",videoDuration:"\u89C6\u9891\u65F6\u957F",tags:"\u8BDD\u9898\u5217\u8868",likes:"\u70B9\u8D5E\u6570",collects:"\u6536\u85CF\u6570",shares:"\u8F6C\u53D1\u6570",comments:"\u8BC4\u8BBA\u6570",ipLocation:"\u53D1\u6587\u5730\u5740",dataFetchTime:"\u6570\u636E\u83B7\u53D6\u65F6\u95F4",errorMsg:"\u63D0\u793A\u4FE1\u606F"},Ve={video:"\u89C6\u9891\u7B14\u8BB0",image:"\u56FE\u6587\u7B14\u8BB0",text:"\u6587\u672C\u7B14\u8BB0"},_e={processing:"\u5904\u7406\u4E2D",processingProgress:"\u5904\u7406\u8FDB\u5EA6",verifyingAuth:"\u6B63\u5728\u9A8C\u8BC1\u6388\u6743...",fetchingData:"\u83B7\u53D6\u6570\u636E\u4E2D...",savingData:"\u4FDD\u5B58\u6570\u636E\u4E2D...",downloadingCover:"\u4E0B\u8F7D\u5C01\u9762\u56FE\u7247...",savingCover:"\u4FDD\u5B58\u5C01\u9762\u56FE\u7247...",downloadingImages:"\u4E0B\u8F7D\u56FE\u7247\u4E2D...",settingNoteType:"\u8BBE\u7F6E\u7B14\u8BB0\u7C7B\u578B...",settingDataTime:"\u8BBE\u7F6E\u6570\u636E\u83B7\u53D6\u65F6\u95F4...",completed:"\u5B8C\u6210"},je={processingComplete:"\u5904\u7406\u5B8C\u6210\uFF01",success:"\u6210\u529F",recordsUpdated:"\u8BB0\u5F55\u66F4\u65B0",failedCount:"\u5931\u8D25\u6570\u91CF",skippedEmpty:"\u8DF3\u8FC7\u7A7A\u503C",attachmentRefreshHint:"\u5982\u679C\u9644\u4EF6\u6CA1\u6709\u663E\u793A\uFF0C\u8BF7\u5237\u65B0\u9875\u9762\u67E5\u770B\u3002",selectAtLeastOneField:"\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5B57\u6BB5",processingFailed:"\u5904\u7406\u5931\u8D25",pleaseLoginFirst:"\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743",refreshingUserInfo:"\u6B63\u5728\u5237\u65B0\u7528\u6237\u4FE1\u606F...",userInfoRefreshSuccess:"\u7528\u6237\u4FE1\u606F\u5237\u65B0\u6210\u529F",refreshFailed:"\u5237\u65B0\u5931\u8D25",authorizationExpired:"\u6388\u6743\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55",unknownError:"\u672A\u77E5\u9519\u8BEF",selectTableAndColumn:"\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868\u548C\u7B14\u8BB0\u94FE\u63A5\u5217",pleaseFillCookie:"\u8BF7\u586B\u5199Cookie\u4FE1\u606F",cannotGetViewInfo:"\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u89C6\u56FE\u4FE1\u606F\uFF0C\u8BF7\u786E\u4FDD\u5DF2\u9009\u62E9\u4E00\u4E2A\u89C6\u56FE",renew:"\u7EED\u8D39",activate:"\u5F00\u901A",todayDownload:"\u4ECA\u65E5\u4E0B\u8F7D",vipLevel:"VIP\u7B49\u7EA7",expireTime:"\u5230\u671F\u65F6\u95F4",refresh:"\u5237\u65B0",contactSupport:"\u8054\u7CFB\u6280\u672F\u652F\u6301",joinChatGroup:"\u4EA4\u6D41\u7FA4"},He={title:"\u6E29\u99A8\u63D0\u793A",point1:"\u672C\u5DE5\u5177\u4EC5\u4F5C\u4E3A\u4E2A\u4EBA\u6570\u636E\u7BA1\u7406\u5DE5\u5177\uFF0C\u5E2E\u52A9\u7528\u6237\u6574\u7406\u548C\u7BA1\u7406\u5C0F\u7EA2\u4E66\u5E73\u53F0\u4E0A\u7684\u4E2A\u4EBA\u6536\u85CF\u4FE1\u606F",point2:"\u6240\u6709\u5185\u5BB9\u7684\u7248\u6743\u5F52\u539F\u4F5C\u8005\u53CA\u5C0F\u7EA2\u4E66\u5E73\u53F0\u6240\u6709\uFF0C\u672C\u5DE5\u5177\u4EC5\u63D0\u4F9B\u7D22\u5F15\u548C\u5BFC\u51FA\u529F\u80FD",point3:"\u7528\u6237\u5BFC\u51FA\u7684\u6570\u636E\u5E94\u4EC5\u7528\u4E8E\u4E2A\u4EBA\u5B66\u4E60\u3001\u7814\u7A76\u53CA\u5408\u6CD5\u5408\u89C4\u7684\u975E\u5546\u4E1A\u7528\u9014",point4:"\u53EF\u80FD\u4F1A\u6536\u53D6\u7EF4\u62A4\u8D39\u7528\uFF0C\u7528\u4E8E\u6301\u7EED\u6539\u8FDB\u548C\u4F18\u5316\u7528\u6237\u4F53\u9A8C",point5:"\u4F7F\u7528\u672C\u5DE5\u5177\u5373\u8868\u793A\u60A8\u5DF2\u9605\u8BFB\u5E76\u540C\u610F\u9075\u5B88\u5E73\u53F0\u670D\u52A1\u6761\u6B3E\uFF0C\u5BF9\u4F7F\u7528\u884C\u4E3A\u8D1F\u5168\u90E8\u8D23\u4EFB"},qe={failed:"\u6388\u6743\u5931\u8D25",failedMessage:"\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458",tenantKey:"Tenant Key"},Xe={normalUser:"\u666E\u901A\u7528\u6237",membershipExpired:"\u4F1A\u5458\u5DF2\u8FC7\u671F",processingPaused:"\u5DF2\u6682\u505C",initializing:"\u521D\u59CB\u5316...",fetchingRecord:"\u83B7\u53D6\u8BB0\u5F55\u4E2D...",requestingData:"\u8BF7\u6C42\u6570\u636E\u4E2D...",savingRecord:"\u4FDD\u5B58\u8BB0\u5F55\u6570\u636E...",settingCover:"\u8BBE\u7F6E\u5C01\u9762\u56FE\u7247...",settingImages:"\u8BBE\u7F6E\u56FE\u7247\u5217\u8868...",savingImages:"\u4FDD\u5B58\u56FE\u7247\u5217\u8868...",waitingUpload:"\u7B49\u5F85\u9644\u4EF6\u4E0A\u4F20...",verifyingCover:"\u9A8C\u8BC1\u5C01\u9762\u56FE\u7247...",verifyingImages:"\u9A8C\u8BC1\u56FE\u7247\u5217\u8868...",downloadImage:"\u4E0B\u8F7D\u56FE\u7247",readImageData:"\u8BFB\u53D6\u56FE\u7247\u6570\u636E",createImageFile:"\u521B\u5EFA\u56FE\u7247\u6587\u4EF6",retryDownload:"\u91CD\u8BD5\u4E0B\u8F7D\u56FE\u7247",imageDownloadProgress:"\u4E0B\u8F7D\u56FE\u7247",dataFetchFailed:"\u6570\u636E\u83B7\u53D6\u5931\u8D25",processingError:"\u5904\u7406\u9519\u8BEF",errorStatus:"\u9519\u8BEF",fieldCreateFailed:"\u90E8\u5206\u5B57\u6BB5\u521B\u5EFA\u5931\u8D25",fieldCreateFailedDetail:". \u8BF7\u68C0\u67E5\u8868\u683C\u6743\u9650\u6216\u5237\u65B0\u9875\u9762\u91CD\u8BD5\u3002",noRecordsSelected:"\u672A\u9009\u62E9\u4EFB\u4F55\u8BB0\u5F55\uFF0C\u5DF2\u53D6\u6D88\u5904\u7406",startProcessing:"\u5F00\u59CB\u5904\u7406",selectedRecords:"\u6761\u9009\u4E2D\u6570\u636E",selectRecords:"\u8BF7\u5728\u5F39\u51FA\u7684\u5BF9\u8BDD\u6846\u4E2D\u9009\u62E9\u8981\u5904\u7406\u7684\u8BB0\u5F55...",completed:"\u5B8C\u6210",link:"\u94FE\u63A5",text:"\u6587\u672C",second:"\u79D2"},Ke={title:Re,subtitle:Me,form:Oe,fields:ze,noteTypes:Ve,processing:_e,messages:je,disclaimer:He,auth:qe,status:Xe},Ge="Xiaohongshu Note Extractor",Je="Batch collect Xiaohongshu note data and process image attachments",We={selectTable:"Select Data Table",selectTablePlaceholder:"Please select a data table",selectColumn:"Select Note Link Column",selectColumnPlaceholder:"Please select a data table first",selectColumnHint:"Please select the column containing Xiaohongshu links or note IDs (text or link type)",selectFields:"Select Fields to Add",selectAll:"Select All",deselectAll:"Deselect All",cookieInput:"Cookie",cookieRequired:"Required field for fetching Xiaohongshu note data",cookieSaved:"\u2705 Cookie saved locally, will auto-fill next time",cookieExpired:"\u26A0\uFE0F Local cookie has expired (over 30 days), please re-enter",cookieLink:"Cookie Acquisition Guide",startProcessing:"Start Processing",pauseProcessing:"Pause Processing",resumeProcessing:"Resume Processing",requiredField:"Status Message (Required)",requiredFieldHint:"Used to display processing status, error messages or success messages"},Qe={noteId:"Xiaohongshu Link or Note ID",authorNickname:"Author Nickname",authorRedId:"Author Red ID",authorXhsUrl:"Author Homepage URL",authorFansCount:"Author Fans Count",authorDesc:"Author Description",title:"Note Title",description:"Note Content",noteType:"Note Type",publishTime:"Publish Time",coverUrl:"Cover Image",images:"Image List",videoUrl:"Video URL",videoDuration:"Video Duration",tags:"Topic List",likes:"Likes",collects:"Collections",shares:"Shares",comments:"Comments",ipLocation:"Post Location",dataFetchTime:"Data Fetch Time",errorMsg:"Status Message"},Ye={video:"Video Note",image:"Image Note",text:"Text Note"},Ze={processing:"Processing",processingProgress:"Processing Progress",verifyingAuth:"Verifying authorization...",fetchingData:"Fetching data...",savingData:"Saving data...",downloadingCover:"Downloading cover image...",savingCover:"Saving cover image...",downloadingImages:"Downloading images...",settingNoteType:"Setting note type...",settingDataTime:"Setting data fetch time...",completed:"Completed"},et={processingComplete:"Processing Complete!",success:"Success",recordsUpdated:"Records Updated",failedCount:"Failed Count",skippedEmpty:"Skipped Empty",attachmentRefreshHint:"If attachments are not showing, please refresh the page to view.",selectAtLeastOneField:"Please select at least one field",processingFailed:"Processing Failed",pleaseLoginFirst:"Please re-login to get authorization",refreshingUserInfo:"Refreshing user information...",userInfoRefreshSuccess:"User information refreshed successfully",refreshFailed:"Refresh Failed",authorizationExpired:"Authorization has expired, please re-login",unknownError:"Unknown Error",selectTableAndColumn:"Please select a data table and note link column first",pleaseFillCookie:"Please fill in Cookie information",cannotGetViewInfo:"Unable to get current view information, please ensure a view is selected",renew:"Renew",activate:"Activate",todayDownload:"Today's Downloads",vipLevel:"VIP Level",expireTime:"Expire Time",refresh:"Refresh",contactSupport:"Contact Support",joinChatGroup:"Join Chat Group"},tt={title:"Friendly Reminder",point1:"This tool is only for personal data management, helping users organize and manage personal collections on the Xiaohongshu platform",point2:"All content rights belong to the original authors and Xiaohongshu platform. This tool only provides indexing and export functions",point3:"Exported data should only be used for personal learning, research and legal, compliant non-commercial purposes",point4:"Maintenance fees may be charged for continuous improvement and optimization of user experience",point5:"Using this tool indicates that you have read and agree to comply with the platform's terms of service and are fully responsible for your usage"},ot={failed:"Authorization Failed",failedMessage:"Unable to verify your authorization information. Please provide the following information to the administrator",tenantKey:"Tenant Key"},st={normalUser:"Normal User",membershipExpired:"Membership Expired",processingPaused:"Paused",initializing:"Initializing...",fetchingRecord:"Fetching record...",requestingData:"Requesting data...",savingRecord:"Saving record data...",settingCover:"Setting cover image...",settingImages:"Setting image list...",savingImages:"Saving image list...",waitingUpload:"Waiting for upload...",verifyingCover:"Verifying cover image...",verifyingImages:"Verifying image list...",downloadImage:"Download image",readImageData:"Read image data",createImageFile:"Create image file",retryDownload:"Retry download",imageDownloadProgress:"Downloading image",dataFetchFailed:"Data fetch failed",processingError:"Processing error",errorStatus:"Error",fieldCreateFailed:"Some fields failed to create",fieldCreateFailedDetail:". Please check table permissions or refresh page and retry.",noRecordsSelected:"No records selected, processing cancelled",startProcessing:"Start processing",selectedRecords:"selected records",selectRecords:"Please select the records to process in the dialog...",completed:"Completed",link:"Link",text:"Text",second:"s"},it={title:Ge,subtitle:Je,form:We,fields:Qe,noteTypes:Ye,processing:Ze,messages:et,disclaimer:tt,auth:ot,status:st};n.use(Ne).init({resources:{zh:{translation:Ke},en:{translation:it}},fallbackLng:"zh",debug:!1,interpolation:{escapeValue:!1}}).then(()=>{Ue.init(n,o,{tName:"t",i18nName:"i18n",handleName:"localize",selectorAttr:"data-i18n",targetAttr:"i18n-target",optionsAttr:"i18n-options",parseOptionsFromContent:!0}),te()});function te(){o("[data-i18n]").localize(),document.title=n.t("title"),document.documentElement.lang=n.language}function S(e,t="processing"){const i=document.getElementById("status");i&&(i.textContent=e,i.className=`status ${t}`,i.style.display="block",(t==="success"||t==="error")&&setTimeout(()=>{i.style.display="none"},3e3))}function xe(e){const t=document.createElement("div");t.textContent=e,t.style.cssText=`
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #4CAF50;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 10000;
    margin-top: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: opacity 0.3s ease;
  `;const i=document.getElementById("cookieInput");if(i){const l=i.getBoundingClientRect(),s=i.closest(".form-group");if(s){const a=s.getBoundingClientRect();t.style.position="fixed",t.style.left=l.left+"px",t.style.top=l.bottom-a.top-40+"px",s.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}}}function B(e,t,i){const l=`[${e}/${t}] ${i}`;o("#processColumn").text(l);const s=Math.round(e/t*100),a=o("#progressContainer"),u=o("#progressBar"),m=o("#progressText"),C=o("#progressPercent");if(a.length===0){console.error("Progress container not found!");return}if(u.length===0){console.error("Progress bar not found!");return}a.show().addClass("show"),u.css("width",`${s}%`),u[0]&&(u[0].style.width=`${s}%`,u[0].style.minWidth="2px"),u.attr("style",`height: 100%; background: linear-gradient(90deg, #ff2442 0%, #ff6b6b 100%); width: ${s}%; border-radius: 4px; transition: width 0.3s ease; position: relative; min-width: 2px !important;`),m.text(i),C.text(`${s}%`),u[0].offsetHeight}function ke(){const e=o("#progressContainer");e.removeClass("show"),setTimeout(()=>{e.hide()},300)}function nt(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="visible",e.style.opacity="1")}function rt(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="hidden",e.style.opacity="0")}async function at(){try{const e=await L.bridge.getTenantKey(),t=await L.bridge.getBaseUserId();if(!e||!t)return console.error("Missing tenant key or user ID"),{success:!1};const i=new FormData;i.append("tenantKey",e),i.append("userId",t);const l=await fetch("https://shop.leshangyundian.com/feishu/user/login",{method:"POST",body:i});if(l.ok){const s=await l.json();return s.success===!0&&s.data?(lt(s.data.token),oe(s.data),Q(s.data),{success:!0,data:s.data}):{success:!1}}else return console.error("Authorization failed:",l.status,l.statusText),{success:!1}}catch(e){return console.error("Authorization error:",e),{success:!1}}}function lt(e){localStorage.setItem("xhsnote_token",e)}function J(){return localStorage.getItem("xhsnote_token")}function oe(e){localStorage.setItem("xhsnote_user_info",JSON.stringify(e))}function Ie(){const e=localStorage.getItem("xhsnote_user_info");if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse saved user info:",t)}return null}function Q(e){o("#userName").text(e.userName||""),e.vipLevelName?(o("#vipLevelName").text(e.vipLevelName),o("#vipLevelName").css("color","#ff2442")):(o("#vipLevelName").text(n.t("messages.normalUser")),o("#vipLevelName").css("color","#666"));let t=!1;const i=new Date;if(e.vipExpire&&e.vipLevel>0){const l=new Date(e.vipExpire),s=l.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});t=l<i,o("#vipExpireTime").text(s),o("#vipExpireInfo").show(),t&&(o("#vipExpireInfo").find("span").eq(0).text(n.t("messages.membershipExpired")),o("#vipExpireTime").css("color","#ff6b6b"))}else e.vipLevel===0?o("#vipExpireInfo").hide():o("#vipExpireInfo").hide();e.todayDownloadCount!==void 0?o("#todayDownloadCount").text(e.todayDownloadCount):o("#todayDownloadCount").text("0"),e.maxDailyDownloads!==void 0?o("#maxDailyDownloads").text(e.maxDailyDownloads):o("#maxDailyDownloads").text("--"),e.vipLevel===0||t?(o("#rechargeBtn").show(),t?(o("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u7EED\u8D39
      `),o("#vipLevelName").css("color","#ff6b6b")):o("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u5F00\u901A
      `)):o("#rechargeBtn").hide(),t&&S(n.t("messages.membershipExpired"),"error"),o("#userInfo").show()}function ct(e){localStorage.setItem("xhsnote_cookies",e),localStorage.setItem("xhsnote_cookies_timestamp",Date.now().toString())}function dt(){const e=localStorage.getItem("xhsnote_cookies"),t=localStorage.getItem("xhsnote_cookies_timestamp");return e&&t&&(Date.now()-parseInt(t))/864e5>30?(ut(),null):e}function ut(){localStorage.removeItem("xhsnote_cookies"),localStorage.removeItem("xhsnote_cookies_timestamp")}function gt(){localStorage.removeItem("xhsnote_token"),localStorage.removeItem("xhsnote_user_info"),localStorage.removeItem("xhsnote_cookies")}function pt(e){if(!e)return[];const t=[],i=/#([^#\[\]]+)\[话题\]#/g;let l;for(;(l=i.exec(e))!==null;)t.push(l[1]);return t}function W(e){if(!e||typeof e!="string")return 0;const t=e.trim();if(/^\d+$/.test(t))return parseInt(t,10);const i=[/^([\d.]+)万/,/^(\d+)千\+?$/,/^([\d.]+)千$/,/^([\d.]+)k/,/^(\d+)$/];for(const l of i){const s=t.match(l);if(s){const a=parseFloat(s[1]);if(l===i[0])return Math.round(a*1e4);if(l===i[1]||l===i[2])return Math.round(a*1e3);if(l===i[3])return Math.round(a*1e3);if(l===i[4])return parseInt(String(a),10)}}return console.warn(`\u65E0\u6CD5\u89E3\u6790\u6570\u5B57\u683C\u5F0F: ${e}`),0}function ft(e){localStorage.setItem("xhsnote_selected_fields",JSON.stringify(e))}function mt(){const e=localStorage.getItem("xhsnote_selected_fields");if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse saved field selection:",t)}return["noteId","authorNickname","authorRedId","authorXhsUrl","authorFansCount","authorDesc","title","description","dataFetchTime","coverUrl","images"]}const Ee={noteId:{label:"\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID",type:y.Text},authorNickname:{label:"\u535A\u4E3B\u6635\u79F0",type:y.Text},authorRedId:{label:"\u535A\u4E3B\u5C0F\u7EA2\u4E66\u53F7",type:y.Text},authorXhsUrl:{label:"\u535A\u4E3B\u4E3B\u9875\u94FE\u63A5",type:y.Url},authorFansCount:{label:"\u535A\u4E3B\u7C89\u4E1D\u6570",type:y.Number},authorDesc:{label:"\u535A\u4E3B\u7B80\u4ECB",type:y.Text},title:{label:"\u7B14\u8BB0\u6807\u9898",type:y.Text},description:{label:"\u7B14\u8BB0\u5185\u5BB9",type:y.Text},noteType:{label:"\u7B14\u8BB0\u7C7B\u578B",type:y.SingleSelect},publishTime:{label:"\u53D1\u5E03\u65F6\u95F4",type:y.Text},coverUrl:{label:"\u5C01\u9762\u56FE",type:y.Attachment},images:{label:"\u56FE\u7247\u5217\u8868",type:y.Attachment},videoUrl:{label:"\u89C6\u9891\u5730\u5740",type:y.Url},videoDuration:{label:"\u89C6\u9891\u65F6\u957F",type:y.Text},tags:{label:"\u8BDD\u9898\u5217\u8868",type:y.MultiSelect},likes:{label:"\u70B9\u8D5E\u6570",type:y.Number},collects:{label:"\u6536\u85CF\u6570",type:y.Number},shares:{label:"\u8F6C\u53D1\u6570",type:y.Number},comments:{label:"\u8BC4\u8BBA\u6570",type:y.Number},ipLocation:{label:"\u53D1\u6587\u5730\u5740",type:y.Text},dataFetchTime:{label:"\u6570\u636E\u83B7\u53D6\u65F6\u95F4",type:y.DateTime},errorMsg:{label:"\u63D0\u793A\u4FE1\u606F",type:y.Text}};function De(){const e=[];if(o('input[name="fields"]:checked').each(function(){const t=o(this).val(),i=Ee[t];i&&e.push({name:t,label:i.label,type:i.type})}),!e.some(t=>t.name==="errorMsg")){const t=Ee.errorMsg;t&&e.push({name:"errorMsg",label:t.label,type:t.type})}return e}async function ht(e,t,i){try{let s=(await e.getFieldMetaList()).find(u=>u.name===t);if(s)return s.type!==i,s.id;const a=await e.addField({type:i,name:t});if(t==="\u7B14\u8BB0\u7C7B\u578B"&&i===y.SingleSelect)try{await(await e.getField(a)).addOptions([{name:"\u89C6\u9891\u7B14\u8BB0"},{name:"\u56FE\u6587\u7B14\u8BB0"},{name:"\u6587\u672C\u7B14\u8BB0"}])}catch(u){console.error("Failed to add options for noteType field:",u)}return a}catch(l){return console.error(`Error creating field "${t}":`,l),""}}async function yt(e,t){try{return(await e.getFieldMetaList()).some(l=>l.id===t)}catch(i){return console.error(`Field validation error for ID ${t}:`,i),!1}}async function Ft(e){const t=new Map,i=De();if(i.length===0)return S(n.t("messages.selectAtLeastOneField"),"error"),t;const l=await e.getFieldMetaList();for(const a of l){const u=i.find(m=>m.label===a.name);if(u&&a.type!==u.type)try{await e.deleteField(a.id)}catch(m){console.error(`Failed to delete field ${a.name}:`,m)}}await e.getFieldMetaList();for(const a of i)try{const m=await ht(e,a.label,a.type)||"";m?(await yt(e,m)||console.error(`Field ${a.name} failed validation`),t.set(a.name,m)):console.error(`Failed to get ID for field ${a.name}`)}catch(u){console.error(`Failed to create field ${a.label}:`,u)}return i.some(a=>a.name==="tags")&&await wt(e,t.get("tags")),t}async function wt(e,t){if(!!t)try{const i=await e.getRecordIdList(),l=o("#columnSelect").val(),s=new Set;if(!(await e.getRecordById(i[0])).fields[l])return;for(let m=0;m<Math.min(i.length,100);m++){const C=i[m];try{const d=(await e.getRecordById(C)).fields[l];d&&d.text&&pt(d.text).forEach(F=>s.add(F))}catch(r){console.error(`Error scanning record ${m}:`,r)}}s.size>0&&await(await e.getField(t)).addOptions(Array.from(s).map(C=>({name:C})))}catch(i){console.error("Error collecting topics:",i)}}async function vt(e){try{let t=e;e.startsWith("http://")&&(t=e.replace("http://","https://"));const i=await fetch(t,{mode:"cors"});if(!i.ok)return[];const l=await i.blob(),s=`cover_${Date.now()}.${l.type.split("/")[1]||"jpg"}`;return[new File([l],s,{type:l.type})]}catch(t){return console.error("Error processing image URL:",t),console.warn("CORS or download error. Image will be skipped."),[]}}async function bt(e,t,i,l=3,s){let a=e;e.startsWith("http://")&&(a=e.replace("http://","https://"));let u=null;for(let m=1;m<=l;m++)try{s&&s(`${n.t("status.downloadImage")} ${t+1}/${i} (${n.t("status.retryDownload")} ${m}/${l})`);const C=await fetch(a,{mode:"cors",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}});if(!C.ok)throw new Error(`HTTP ${C.status}: ${C.statusText}`);s&&s(`${n.t("status.readImageData")} ${t+1}/${i}`);const r=await C.blob();if(r.size===0)throw new Error("Downloaded file is empty");s&&s(`${n.t("status.createImageFile")} ${t+1}/${i}`);const d=`image_${String(t+1).padStart(3,"0")}_${Date.now()}.${r.type.split("/")[1]||"jpg"}`;return new File([r],d,{type:r.type})}catch(C){if(u=C,console.warn(`\u274C Attempt ${m}/${l} failed for image ${t+1}:`,C instanceof Error?C.message:String(C)),m<l){const r=m*1e3;s&&s(`${n.t("status.retryDownload")} ${n.t("status.imageDownloadProgress")} ${t+1}/${i} (${n.t("status.retryDownload")} after ${r}ms)`),await new Promise(d=>setTimeout(d,r))}}return console.error(`\u{1F4A5} All attempts failed for image ${t+1}:`,u),null}async function xt(e,t){if(!e||e.length===0)return[];const i=[],l=3;for(let s=0;s<e.length;s++){const a=e[s];t&&t(s+1,e.length,`${n.t("status.imageDownloadProgress")} ${s+1}/${e.length}`);try{const u=await bt(a,s,e.length,l,m=>{t&&t(s+1,e.length,m)});u?i.push(u):console.warn(`\u26A0\uFE0F Skipped image ${s+1} due to download failure`)}catch(u){console.error(`\u{1F4A5} Unexpected error processing image ${s+1}:`,u)}s<e.length-1&&await new Promise(u=>setTimeout(u,200))}if(i.length<e.length){const s=e.length-i.length;console.warn(`\u26A0\uFE0F ${s} images failed to download and will be skipped`)}return i}async function Ce(e){try{const i=await(await L.base.getTableById(e)).getFieldMetaList();if(o("#columnSelect").empty(),i&&i.length>0){const l=i.filter(s=>s.type===y.Text||s.type===y.Url);if(l.length>0){const s=l.map(a=>{const u=a.type===y.Url?n.t("status.link"):n.t("status.text");return`<option value="${a.id}">${a.name} (${u})</option>`}).join("");o("#columnSelect").append('<option value="">\u8BF7\u9009\u62E9\u7B14\u8BB0\u94FE\u63A5\u5217</option>'),o("#columnSelect").append(s)}else o("#columnSelect").append('<option value="">\u672A\u627E\u5230\u53EF\u7528\u7684\u7B14\u8BB0\u94FE\u63A5\u5217</option>')}else o("#columnSelect").append('<option value="">\u6CA1\u6709\u53EF\u7528\u7684\u5217</option>')}catch(t){console.error("Error loading columns:",t),o("#columnSelect").empty().append('<option value="">\u52A0\u8F7D\u5217\u5931\u8D25</option>')}}o(document).ready(async function(){window.addEventListener("error",function(r){console.error("Uncaught error:",r.error)}),window.addEventListener("unhandledrejection",function(r){console.error("Unhandled promise rejection:",r.reason)});let e=!1,t=!1;try{if(typeof L>"u")console.error("Bitable API not available"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3);else try{const r=await L.bridge.getEnv();(!r.product||r.product!=="feishu"&&r.product!=="lark")&&(console.error("Not in Feishu or Lark environment"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3))}catch(r){console.warn("Environment check failed, but continuing:",r)}}catch(r){console.error("Environment check encountered error:",r)}const i=Ie();if(i&&Q(i),nt(),!(await at()).success){let r="",d="";try{const F=await L.bridge.getTenantKey(),A=await L.bridge.getBaseUserId();r=F||"\u65E0\u6CD5\u83B7\u53D6",d=A||"\u65E0\u6CD5\u83B7\u53D6"}catch(F){console.error("Failed to get debug info:",F)}const T="https://shop.leshangyundian.com/feishu/user/login";o("body").html(`
      <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #ffeef2 0%, #ffe4e8 100%);">
        <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 107, 107, 0.2); max-width: 700px;">
          <div style="font-size: 64px; margin-bottom: 20px;">\u{1F614}</div>
          <h1 style="color: #ff2442; margin-bottom: 16px;">\u6388\u6743\u5931\u8D25</h1>
          <p style="color: #666; margin-bottom: 24px;">\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458</p>

          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <p style="margin: 0 0 10px 0;"><strong>Tenant Key:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${r}</code>

            <p style="margin: 20px 0 10px 0;"><strong>Base User ID:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${d}</code>
      </div>

          <button onclick="location.reload()" style="padding: 12px 32px; background: linear-gradient(135deg, #ff2442 0%, #ff6b6b 100%); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; transition: transform 0.2s; margin-right: 12px;">
            \u91CD\u65B0\u52A0\u8F7D
          </button>
          <button onclick="navigator.clipboard.writeText('Tenant Key: ${r}\\nBase User ID: ${d}\\nURL: ${T}\\nFormData: tenantKey=${r}&userId=${d}')" style="padding: 12px 32px; background: white; color: #ff2442; border: 2px solid #ff2442; border-radius: 12px; font-size: 16px; cursor: pointer; transition: all 0.2s;">
            \u590D\u5236\u4FE1\u606F
          </button>
        </div>
      </div>
    `);return}rt();const s=mt();o('input[name="fields"]').each(function(){const r=o(this).val();r==="errorMsg"?o(this).prop("checked",!0):o(this).prop("checked",s.includes(r))});const a=dt();if(a)o("#cookieInput").val(a),xe(n.t("form.cookieSaved"));else{const r=localStorage.getItem("xhsnote_cookies_timestamp");r&&(Date.now()-parseInt(r))/864e5>30&&xe(n.t("form.cookieExpired"))}try{if(!L.base)throw console.error("bitable.base is undefined"),new Error("bitable.base is not available");const r=await L.base.getTableMetaList(),d=await L.base.getSelection();if(o("#tableSelect").empty(),r&&r.length>0){const T=r.map(F=>`<option value="${F.id}">${F.name}</option>`).join("");o("#tableSelect").append(T),d&&d.tableId&&(o("#tableSelect").val(d.tableId),await Ce(d.tableId))}else o("#tableSelect").append('<option value="">No tables available</option>')}catch(r){console.error("Error loading tables:",r),o("#tableSelect").append('<option value="">Error loading tables</option>')}o("#tableSelect").on("change",async function(){const r=o(this).val();r?await Ce(r):o("#columnSelect").empty().append('<option value="">\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868</option>')}),o("#processColumn").on("click",async function(){try{const r=o("#tableSelect").val(),d=o("#columnSelect").val(),T=J();if(!r||!d){S(n.t("messages.selectTableAndColumn"),"error");return}if(!T){S("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}if(!(o("#cookieInput").val()||"").trim()){S(n.t("messages.pleaseFillCookie"),"error"),o("#cookieInput").focus();return}const A=await L.base.getSelection();if(!A||!A.viewId){S(n.t("messages.cannotGetViewInfo"),"error");return}S(n.t("status.selectRecords"),"processing");const w=await L.ui.selectRecordIdList(r,A.viewId);if(!w||w.length===0){S(n.t("status.noRecordsSelected"),"error");return}e=!0,t=!1,o("#processColumn").prop("disabled",!0),o("#pauseProcess").show(),B(0,w.length,n.t("status.initializing")),S(`${n.t("status.startProcessing")} ${w.length} ${n.t("status.selectedRecords")}...`,"processing");const Te=await L.bridge.getBaseUserId(),Se=await L.bridge.getInstanceId(),D=await L.base.getTableById(r),h=await Ft(D),Y=De().filter(p=>!h.get(p.name));if(Y.length>0){console.error(`Missing selected fields: ${Y.map(p=>p.name).join(", ")}`),S(`${n.t("status.fieldCreateFailed")}: ${Y.map(p=>p.label).join(", ")}${n.t("status.fieldCreateFailedDetail")}`,"error");return}let V=0,z=0,se=0;for(let p=0;p<w.length&&e;p++){const b=w[p];try{for(;t&&e;)B(p,w.length,n.t("status.processingPaused")),await new Promise($=>setTimeout($,1e3));if(!e)break;if(p>0){const $=Math.floor(Math.random()*201)+800;await new Promise(c=>setTimeout(c,$))}B(p,w.length,n.t("status.fetchingRecord"));const I=(await D.getRecordById(b)).fields[d];if(B(p,w.length,n.t("status.requestingData")),!I||Array.isArray(I)&&I.length===0)continue;let P="";if(Array.isArray(I)){let $=!1;for(let c=0;c<I.length;c++){const x=I[c];if(x&&typeof x=="object"&&x.type==="url"&&x.link){P=x.link,$=!0;break}}if(!$&&I.length>0){const c=I[0];c&&typeof c=="object"&&c.text&&(P=c.text)}}else typeof I=="string"?P=I:I&&typeof I=="object"&&("link"in I&&I.link?P=I.link:"text"in I&&I.text&&(P=I.text));if(!P)continue;const _=o("#cookieInput").val()||"";B(p,w.length,n.t("processing.fetchingData"));const U=await fetch("https://shop.leshangyundian.com/feishu/user/vip/xhs/note",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`},body:JSON.stringify({url:P,cookies:_,userId:Te,instanceId:Se})});if(U.ok){const $=await U.json();if($&&$.success===!0){V++;const c=$.data||$;let x="";c.videoUrl?x=n.t("noteTypes.video"):c.imageList&&c.imageList.length>0?x=n.t("noteTypes.image"):x=n.t("noteTypes.text"),B(p,w.length,n.t("processing.savingData"));const E={},O=h.get("noteId");O&&(E[O]=P);const ne=h.get("errorMsg");ne&&(E[ne]="");const re=h.get("authorNickname");if(re){const g=c.authorNickname||c.user&&(c.user.name||c.user.nickname)||"";E[re]=g}const ae=h.get("authorRedId");ae&&(E[ae]=c.authorRedId||"");const le=h.get("authorXhsUrl");le&&(E[le]=c.authorXhsUrl||"");const ce=h.get("authorFansCount");if(ce){const g=c.authorFansCount&&parseInt(c.authorFansCount)||0;E[ce]=g}const de=h.get("authorDesc");de&&(E[de]=c.authorDesc||"");const ue=h.get("title");ue&&(E[ue]=c.title||"");const ge=h.get("description");ge&&(E[ge]=c.desc||"");const j=h.get("noteType");let H=null;if(j&&x)try{const g=await D.getField(j),k=await g.getOptions();if(k.map(v=>v.name).includes(x)){const v=k.find(R=>R.name===x);v&&(H=v.id)}else{await g.addOptions([{name:x}]);const R=(await g.getOptions()).find(be=>be.name===x);R&&(H=R.id)}}catch(g){console.error("Failed to handle noteType field:",g)}const pe=h.get("publishTime");pe&&(E[pe]=c.createTimeStr||"");const q=h.get("dataFetchTime");let X=null;q&&(X=Date.now());let K=[],G=[];if(c.imageList&&c.imageList.length>0){const g=c.imageList[0].imageUrl||c.imageList[0].url||"";g&&(K=await vt(g),K.length>0);const k=c.imageList.map(f=>f.imageUrl||f.url).filter(f=>f);k.length>0&&(G=await xt(k,(f,v,R)=>{B(p,w.length,R)}),G.length>0)}const fe=h.get("videoUrl");fe&&(E[fe]=c.videoUrl||"");const me=h.get("videoDuration");me&&(E[me]=c.videoDuration?`${c.videoDuration}${n.t("status.second")}`:"");const Z=h.get("tags");if(Z){let g=[];c.tags&&(g=c.tags.split(",").map(k=>k.trim()).filter(k=>k));try{const k=await D.getField(Z),f=await k.getOptions();if(g.length>0){const v=f.map(M=>M.name),R=g.filter(M=>!v.includes(M));R.length>0&&await k.addOptions(R.map(M=>({name:M})));const Ae=(await k.getOptions()).filter(M=>g.includes(M.name)).map(M=>M.id);await k.setValue(b,Ae)}else await k.setValue(b,[])}catch(k){console.error("Error handling multi-select field:",k),E[Z]=[]}}const he=h.get("likes");if(he){const g=W(String(c.likedCount));E[he]=g}const ye=h.get("collects");if(ye){const g=W(String(c.collectedCount));E[ye]=g}const Fe=h.get("shares");if(Fe){const g=W(String(c.sharedCount));E[Fe]=g}const we=h.get("comments");if(we){const g=W(String(c.commentsCount));E[we]=g}const ve=h.get("ipLocation");ve&&(E[ve]=c.ipLocation||"");const Le=await D.getFieldMetaList(),ee={};for(const[g,k]of Object.entries(E))Le.find(v=>v.id===g)?ee[g]=k:console.warn(`Field ID ${g} no longer exists, skipping...`);if(Object.keys(ee).length>0){if(B(p,w.length,n.t("status.savingRecord")),await D.setRecord(b,{fields:ee}),se++,K.length>0){const f=h.get("coverUrl");if(f)try{B(p,w.length,"\u8BBE\u7F6E\u5C01\u9762\u56FE\u7247...");const v=await D.getField(f);v?(B(p,w.length,n.t("processing.savingCover")),await v.setValue(b,K)):console.error("Could not get cover field object")}catch(v){console.error("Error setting cover attachments:",v)}}if(G.length>0){const f=h.get("images");if(f)try{B(p,w.length,"\u8BBE\u7F6E\u56FE\u7247\u5217\u8868...");const v=await D.getField(f);v?(B(p,w.length,"\u4FDD\u5B58\u56FE\u7247\u5217\u8868..."),await v.setValue(b,G)):console.error("Could not get images field object")}catch(v){console.error("Error setting image attachments:",v)}}B(p+1,w.length,n.t("status.waitingUpload")),await new Promise(f=>setTimeout(f,3e3));const g=h.get("coverUrl");if(g)try{if(B(p+1,w.length,n.t("status.verifyingCover")),await D.getField(g)){const v=await D.getCellValue(g,b)}}catch(f){console.error("Error getting cover field URLs:",f)}const k=h.get("images");if(k)try{if(B(p+1,w.length,n.t("status.verifyingImages")),await D.getField(k)){const v=await D.getCellValue(k,b)}}catch(f){console.error("Error getting images field URLs:",f)}if(j&&H)try{B(p,w.length,n.t("processing.settingNoteType")),await(await D.getField(j)).setValue(b,H)}catch(f){console.error("Error setting note type value:",f)}if(q&&X!==null)try{B(p,w.length,n.t("processing.settingDataTime"));const f=await D.getField(q);await f.setDateFormat(Pe.DATE_TIME),await f.setValue(b,X)}catch(f){console.error("Error setting data fetch time value:",f);try{await(await D.getField(q)).setValue(b,X)}catch(v){console.error("Error setting data fetch time value without format:",v)}}}else console.warn(`No valid fields to update for record ${b}`)}else{z++;const c=$.msg||$.message||n.t("status.dataFetchFailed"),x=h.get("errorMsg");if(x)try{await D.setRecord(b,{fields:{[x]:c}})}catch(E){console.error(`Failed to save error message for record ${b}:`,E)}}}else{let $=U.statusText;try{const x=await U.json();$=JSON.stringify(x)}catch{$=await U.text()}console.error(`Failed to process record ${p+1}:`,U.status,$),z++;const c=h.get("errorMsg");if(c){const x={};if(x[c]=`${n.t("status.errorStatus")} ${U.status}: ${$}`,(await D.getFieldMetaList()).find(O=>O.id===c))try{await D.setRecord(b,{fields:x})}catch(O){console.error(`Failed to save error message for record ${b}:`,O)}}}}catch(N){console.error(`Error processing record ${p+1}:`,N),z++;const I=h.get("errorMsg");if(I){const P={};P[I]=`${n.t("status.processingError")}: ${N instanceof Error?N.message:String(N)}`;try{if((await D.getFieldMetaList()).find(U=>U.id===I))try{await D.setRecord(b,{fields:P})}catch(U){console.error(`Failed to save error message for record ${b}:`,U)}}catch(_){console.error("Failed to validate field for error message:",_)}}}}e=!1,B(w.length,w.length,n.t("status.completed")),o("#processColumn").prop("disabled",!1).text(n.t("form.startProcessing")),o("#pauseProcess").hide(),setTimeout(()=>{ke()},2e3);const $e=V+z,Be=w.length-$e,ie=`${n.t("messages.processingComplete")}
${n.t("messages.success")}: ${V}
${n.t("messages.recordsUpdated")}: ${se}
${n.t("messages.failedCount")}: ${z}
${n.t("messages.skippedEmpty")}: ${Be}

${n.t("messages.attachmentRefreshHint")}`;if(S(ie,ie.includes(n.t("messages.processingComplete"))?"success":"error"),V>0){const p=J();if(p)try{const b=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`}});if(b.ok){const N=await b.json();N.success===!0&&N.data&&(oe(N.data),Q(N.data))}}catch(b){console.error("Failed to refresh user info after processing:",b)}}}catch(r){console.error("Error processing column:",r),S(n.t("messages.processingFailed")+": "+(r instanceof Error?r.message:String(r)),"error"),e=!1,o("#processColumn").prop("disabled",!1).text(n.t("form.startProcessing")),o("#pauseProcess").hide(),ke()}}),o("#pauseProcess").on("click",function(){t=!t,o(this).text(t?n.t("form.resumeProcessing"):n.t("form.pauseProcessing"))}),o("#refreshUserInfo").on("click",async function(){const r=J();if(!r){S("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}const d=o(this),T=d.find("svg");d.prop("disabled",!0),T.css("animation","spin 1s linear infinite");try{S(n.t("messages.refreshingUserInfo"),"processing");const F=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(F.ok){const A=await F.json();A.success===!0&&A.data?(oe(A.data),Q(A.data),S(n.t("messages.userInfoRefreshSuccess"),"success")):(S(n.t("messages.refreshFailed")+": "+(A.message||n.t("messages.unknownError")),"error"),F.status===401&&(gt(),S(n.t("messages.authorizationExpired"),"error")))}else throw new Error(`HTTP ${F.status}: ${F.statusText}`)}catch(F){console.error("Refresh user info error:",F),S("\u5237\u65B0\u5931\u8D25\uFF1A"+(F instanceof Error?F.message:String(F)),"error")}finally{d.prop("disabled",!1),T.css("animation","")}}),o("#rechargeBtn").on("click",function(){const r=J(),d=Ie();if(d&&d.userId&&r){const T=`https://shop.leshangyundian.com/payment?id=${d.userId}&token=${r}&type=NOTE_VIP`;window.open(T,"_blank")}else S("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error")}),o("#selectAllFields").on("click",function(){o('input[name="fields"]:not(:disabled)').prop("checked",!0),u()}),o("#deselectAllFields").on("click",function(){o('input[name="fields"]:not(:disabled)').each(function(){o(this).prop("checked",!o(this).prop("checked"))}),u()}),o('input[name="fields"]').on("change",u),o("#cookieInput").on("input blur",function(){const r=o(this).val();r&&r.trim()&&ct(r.trim())});function u(){const r=[];o('input[name="fields"]:checked').each(function(){const d=o(this).val();r.push(d)}),ft(r)}o("#languageToggle").on("click",function(){const d=n.language==="zh"?"en":"zh";n.changeLanguage(d,(T,F)=>{if(T)return console.error("Failed to change language:",T);te(),o("#currentLanguage").text(d==="zh"?"\u4E2D\u6587":"English"),m(),localStorage.setItem("preferred_language",d)})});function m(){o('input[name="fields"]').each(function(){const r=o(this).val(),d=o(this).siblings("span").last();if(d&&d.text()){const T=`fields.${r}`,F=n.t(T);F&&F!==T&&d.text(F)}})}const C=localStorage.getItem("preferred_language");C&&["zh","en"].includes(C)&&n.changeLanguage(C,(r,d)=>{if(r)return console.error("Failed to restore language:",r);te(),m(),o("#currentLanguage").text(C==="zh"?"\u4E2D\u6587":"English")})});

import{H as w,p as $}from"./vendor-lark.d494abf6.js";import{$ as o}from"./vendor-jquery.85696251.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))u(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&u(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function u(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();function b(e,t="processing"){const n=document.getElementById("status");n&&(n.textContent=e,n.className=`status ${t}`,n.style.display="block",(t==="success"||t==="error")&&setTimeout(()=>{n.style.display="none"},3e3))}function k(e,t,n){const u=`[${e}/${t}] ${n}`;o("#processColumn").text(u);const i=Math.round(e/t*100),s=o("#progressContainer"),c=o("#progressBar"),r=o("#progressText"),l=o("#progressPercent");if(s.length===0){console.error("Progress container not found!");return}if(c.length===0){console.error("Progress bar not found!");return}s.show().addClass("show"),c.css("width",`${i}%`),c[0]&&(c[0].style.width=`${i}%`,c[0].style.minWidth="2px"),c.attr("style",`height: 100%; background: linear-gradient(90deg, #ff2442 0%, #ff6b6b 100%); width: ${i}%; border-radius: 4px; transition: width 0.3s ease; position: relative; min-width: 2px !important;`),r.text(n),l.text(`${i}%`),c[0].offsetHeight}function ce(){const e=o("#progressContainer");e.removeClass("show"),setTimeout(()=>{e.hide()},300)}function be(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="visible",e.style.opacity="1")}function ve(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="hidden",e.style.opacity="0")}async function De(){try{const e=await $.bridge.getTenantKey(),t=await $.bridge.getBaseUserId();if(!e||!t)return console.error("Missing tenant key or user ID"),{success:!1};const n=new FormData;n.append("tenantKey",e),n.append("userId",t);const u=await fetch("https://shop.leshangyundian.com/feishu/user/login",{method:"POST",body:n});if(u.ok){const i=await u.json();return i.success===!0&&i.data?(xe(i.data.token),ge(i.data),W(i.data),{success:!0,data:i.data}):{success:!1}}else return console.error("Authorization failed:",u.status,u.statusText),{success:!1}}catch(e){return console.error("Authorization error:",e),{success:!1}}}function xe(e){localStorage.setItem("xhsnote_token",e)}function J(){return localStorage.getItem("xhsnote_token")}function ge(e){localStorage.setItem("xhsnote_user_info",JSON.stringify(e))}function de(){const e=localStorage.getItem("xhsnote_user_info");if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse saved user info:",t)}return null}function W(e){o("#userName").text(e.userName||""),e.vipLevelName?(o("#vipLevelName").text(e.vipLevelName),o("#vipLevelName").css("color","#ff2442")):(o("#vipLevelName").text("\u666E\u901A\u7528\u6237"),o("#vipLevelName").css("color","#666"));let t=!1;const n=new Date;if(e.vipExpire&&e.vipLevel>0){const u=new Date(e.vipExpire),i=u.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});t=u<n,o("#vipExpireTime").text(i),o("#vipExpireInfo").show(),t&&(o("#vipExpireInfo").find("span").eq(0).text("\u4F1A\u5458\u5DF2\u8FC7\u671F"),o("#vipExpireTime").css("color","#ff6b6b"))}else e.vipLevel===0?o("#vipExpireInfo").hide():o("#vipExpireInfo").hide();e.todayDownloadCount!==void 0?o("#todayDownloadCount").text(e.todayDownloadCount):o("#todayDownloadCount").text("0"),e.maxDailyDownloads!==void 0?o("#maxDailyDownloads").text(e.maxDailyDownloads):o("#maxDailyDownloads").text("--"),e.vipLevel===0||t?(o("#rechargeBtn").show(),t?(o("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u7EED\u8D39
      `),o("#vipLevelName").css("color","#ff6b6b")):o("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u5F00\u901A
      `)):o("#rechargeBtn").hide(),t&&b("\u4F1A\u5458\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u7EED\u8D39\u540E\u7EE7\u7EED\u4F7F\u7528","error"),o("#userInfo").show()}function Ce(e){localStorage.setItem("xhsnote_cookies",e)}function ke(){return localStorage.getItem("xhsnote_cookies")}function Ie(){localStorage.removeItem("xhsnote_token"),localStorage.removeItem("xhsnote_user_info"),localStorage.removeItem("xhsnote_cookies")}function $e(e){if(!e)return[];const t=[],n=/#([^#\[\]]+)\[话题\]#/g;let u;for(;(u=n.exec(e))!==null;)t.push(u[1]);return t}function V(e){if(!e||typeof e!="string")return 0;const t=e.trim();if(/^\d+$/.test(t))return parseInt(t,10);const n=[/^([\d.]+)万/,/^(\d+)千\+?$/,/^([\d.]+)千$/,/^([\d.]+)k/,/^(\d+)$/];for(const u of n){const i=t.match(u);if(i){const s=parseFloat(i[1]);if(u===n[0])return Math.round(s*1e4);if(u===n[1]||u===n[2])return Math.round(s*1e3);if(u===n[3])return Math.round(s*1e3);if(u===n[4])return parseInt(String(s),10)}}return console.warn(`\u65E0\u6CD5\u89E3\u6790\u6570\u5B57\u683C\u5F0F: ${e}`),0}function Te(e){localStorage.setItem("xhsnote_selected_fields",JSON.stringify(e))}function Se(){const e=localStorage.getItem("xhsnote_selected_fields");if(e)try{return JSON.parse(e)}catch(t){console.error("Failed to parse saved field selection:",t)}return["noteId","authorNickname","title","description","coverUrl","images"]}const fe={noteId:{label:"\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID",type:w.Text},authorNickname:{label:"\u4F5C\u8005\u6635\u79F0",type:w.Text},authorXhsId:{label:"\u4F5C\u8005\u5C0F\u7EA2\u4E66\u53F7",type:w.Text},title:{label:"\u7B14\u8BB0\u6807\u9898",type:w.Text},description:{label:"\u7B14\u8BB0\u5185\u5BB9",type:w.Text},noteType:{label:"\u7B14\u8BB0\u7C7B\u578B",type:w.Text},publishTime:{label:"\u53D1\u5E03\u65F6\u95F4",type:w.Text},coverUrl:{label:"\u5C01\u9762\u56FE",type:w.Attachment},images:{label:"\u56FE\u7247\u5217\u8868",type:w.Attachment},videoUrl:{label:"\u89C6\u9891\u5730\u5740",type:w.Url},videoDuration:{label:"\u89C6\u9891\u65F6\u957F",type:w.Text},tags:{label:"\u8BDD\u9898\u5217\u8868",type:w.MultiSelect},likes:{label:"\u70B9\u8D5E\u6570",type:w.Number},collects:{label:"\u6536\u85CF\u6570",type:w.Number},shares:{label:"\u8F6C\u53D1\u6570",type:w.Number},comments:{label:"\u8BC4\u8BBA\u6570",type:w.Number},ipLocation:{label:"\u53D1\u6587\u5730\u5740",type:w.Text},errorMsg:{label:"\u63D0\u793A\u4FE1\u606F",type:w.Text}};function he(){const e=[];if(o('input[name="fields"]:checked').each(function(){const t=o(this).val(),n=fe[t];n&&e.push({name:t,label:n.label,type:n.type})}),!e.some(t=>t.name==="errorMsg")){const t=fe.errorMsg;t&&e.push({name:"errorMsg",label:t.label,type:t.type})}return e}async function Ae(e,t,n){try{let i=(await e.getFieldMetaList()).find(c=>c.name===t);return i?(i.type!==n,i.id):await e.addField({type:n,name:t})}catch(u){return console.error(`Error creating field "${t}":`,u),""}}async function Le(e,t){try{return(await e.getFieldMetaList()).some(u=>u.id===t)}catch(n){return console.error(`Field validation error for ID ${t}:`,n),!1}}async function Me(e){const t=new Map,n=he();if(n.length===0)return b("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5B57\u6BB5","error"),t;const u=await e.getFieldMetaList();for(const s of u){const c=n.find(r=>r.label===s.name);if(c&&s.type!==c.type)try{await e.deleteField(s.id)}catch(r){console.error(`Failed to delete field ${s.name}:`,r)}}await e.getFieldMetaList();for(const s of n)try{const r=await Ae(e,s.label,s.type)||"";r?(await Le(e,r)||console.error(`Field ${s.name} failed validation`),t.set(s.name,r)):console.error(`Failed to get ID for field ${s.name}`)}catch(c){console.error(`Failed to create field ${s.label}:`,c)}return n.some(s=>s.name==="tags")&&await Ne(e,t.get("tags")),t}async function Ne(e,t){if(!!t)try{const n=await e.getRecordIdList(),u=o("#columnSelect").val(),i=new Set;if(!(await e.getRecordById(n[0])).fields[u])return;for(let r=0;r<Math.min(n.length,100);r++){const l=n[r];try{const f=(await e.getRecordById(l)).fields[u];f&&f.text&&$e(f.text).forEach(g=>i.add(g))}catch(m){console.error(`Error scanning record ${r}:`,m)}}i.size>0&&await(await e.getField(t)).addOptions(Array.from(i).map(l=>({name:l})))}catch(n){console.error("Error collecting topics:",n)}}async function Ue(e){try{let t=e;e.startsWith("http://")&&(t=e.replace("http://","https://"));const n=await fetch(t,{mode:"cors"});if(!n.ok)return[];const u=await n.blob(),i=`cover_${Date.now()}.${u.type.split("/")[1]||"jpg"}`;return[new File([u],i,{type:u.type})]}catch(t){return console.error("Error processing image URL:",t),console.warn("CORS or download error. Image will be skipped."),[]}}async function Oe(e,t,n,u=3,i){let s=e;e.startsWith("http://")&&(s=e.replace("http://","https://"));let c=null;for(let r=1;r<=u;r++)try{i&&i(`\u4E0B\u8F7D\u56FE\u7247 ${t+1}/${n} (\u5C1D\u8BD5 ${r}/${u})`);const l=await fetch(s,{mode:"cors",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}});if(!l.ok)throw new Error(`HTTP ${l.status}: ${l.statusText}`);i&&i(`\u8BFB\u53D6\u56FE\u7247\u6570\u636E ${t+1}/${n}`);const m=await l.blob();if(m.size===0)throw new Error("Downloaded file is empty");i&&i(`\u521B\u5EFA\u56FE\u7247\u6587\u4EF6 ${t+1}/${n}`);const f=`image_${String(t+1).padStart(3,"0")}_${Date.now()}.${m.type.split("/")[1]||"jpg"}`;return new File([m],f,{type:m.type})}catch(l){if(c=l,console.warn(`\u274C Attempt ${r}/${u} failed for image ${t+1}:`,l instanceof Error?l.message:String(l)),r<u){const m=r*1e3;i&&i(`\u91CD\u8BD5\u4E0B\u8F7D\u56FE\u7247 ${t+1}/${n} (${m}ms\u540E\u91CD\u8BD5)`),await new Promise(f=>setTimeout(f,m))}}return console.error(`\u{1F4A5} All attempts failed for image ${t+1}:`,c),null}async function Pe(e,t){if(!e||e.length===0)return[];const n=[],u=3;for(let i=0;i<e.length;i++){const s=e[i];t&&t(i+1,e.length,`\u4E0B\u8F7D\u56FE\u7247 ${i+1}/${e.length}`);try{const c=await Oe(s,i,e.length,u,r=>{t&&t(i+1,e.length,r)});c?n.push(c):console.warn(`\u26A0\uFE0F Skipped image ${i+1} due to download failure`)}catch(c){console.error(`\u{1F4A5} Unexpected error processing image ${i+1}:`,c)}i<e.length-1&&await new Promise(c=>setTimeout(c,200))}if(n.length<e.length){const i=e.length-n.length;console.warn(`\u26A0\uFE0F ${i} images failed to download and will be skipped`)}return n}async function pe(e){try{const n=await(await $.base.getTableById(e)).getFieldMetaList();if(o("#columnSelect").empty(),n&&n.length>0){const u=n.filter(i=>i.type===w.Text||i.type===w.Url);if(u.length>0){const i=u.map(s=>{const c=s.type===w.Url?"\u94FE\u63A5":"\u6587\u672C";return`<option value="${s.id}">${s.name} (${c})</option>`}).join("");o("#columnSelect").append('<option value="">\u8BF7\u9009\u62E9\u7B14\u8BB0\u94FE\u63A5\u5217</option>'),o("#columnSelect").append(i)}else o("#columnSelect").append('<option value="">\u672A\u627E\u5230\u53EF\u7528\u7684\u7B14\u8BB0\u94FE\u63A5\u5217</option>')}else o("#columnSelect").append('<option value="">\u6CA1\u6709\u53EF\u7528\u7684\u5217</option>')}catch(t){console.error("Error loading columns:",t),o("#columnSelect").empty().append('<option value="">\u52A0\u8F7D\u5217\u5931\u8D25</option>')}}o(document).ready(async function(){window.addEventListener("error",function(r){console.error("Uncaught error:",r.error)}),window.addEventListener("unhandledrejection",function(r){console.error("Unhandled promise rejection:",r.reason)});let e=!1,t=!1;try{if(typeof $>"u")console.error("Bitable API not available"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3);else try{const r=await $.bridge.getEnv();(!r.product||r.product!=="feishu"&&r.product!=="lark")&&(console.error("Not in Feishu or Lark environment"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3))}catch(r){console.warn("Environment check failed, but continuing:",r)}}catch(r){console.error("Environment check encountered error:",r)}const n=de();if(n&&W(n),be(),!(await De()).success){let r="",l="";try{const f=await $.bridge.getTenantKey(),T=await $.bridge.getBaseUserId();r=f||"\u65E0\u6CD5\u83B7\u53D6",l=T||"\u65E0\u6CD5\u83B7\u53D6"}catch(f){console.error("Failed to get debug info:",f)}const m="https://shop.leshangyundian.com/feishu/user/login";o("body").html(`
      <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #ffeef2 0%, #ffe4e8 100%);">
        <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 107, 107, 0.2); max-width: 700px;">
          <div style="font-size: 64px; margin-bottom: 20px;">\u{1F614}</div>
          <h1 style="color: #ff2442; margin-bottom: 16px;">\u6388\u6743\u5931\u8D25</h1>
          <p style="color: #666; margin-bottom: 24px;">\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458</p>

          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <p style="margin: 0 0 10px 0;"><strong>Tenant Key:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${r}</code>

            <p style="margin: 20px 0 10px 0;"><strong>Base User ID:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${l}</code>
      </div>

          <button onclick="location.reload()" style="padding: 12px 32px; background: linear-gradient(135deg, #ff2442 0%, #ff6b6b 100%); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; transition: transform 0.2s; margin-right: 12px;">
            \u91CD\u65B0\u52A0\u8F7D
          </button>
          <button onclick="navigator.clipboard.writeText('Tenant Key: ${r}\\nBase User ID: ${l}\\nURL: ${m}\\nFormData: tenantKey=${r}&userId=${l}')" style="padding: 12px 32px; background: white; color: #ff2442; border: 2px solid #ff2442; border-radius: 12px; font-size: 16px; cursor: pointer; transition: all 0.2s;">
            \u590D\u5236\u4FE1\u606F
          </button>
        </div>
      </div>
    `);return}ve();const i=Se();o('input[name="fields"]').each(function(){const r=o(this).val();r==="errorMsg"?o(this).prop("checked",!0):o(this).prop("checked",i.includes(r))});const s=ke();s&&o("#cookieInput").val(s);try{if(!$.base)throw console.error("bitable.base is undefined"),new Error("bitable.base is not available");const r=await $.base.getTableMetaList(),l=await $.base.getSelection();if(o("#tableSelect").empty(),r&&r.length>0){const m=r.map(f=>`<option value="${f.id}">${f.name}</option>`).join("");o("#tableSelect").append(m),l&&l.tableId&&(o("#tableSelect").val(l.tableId),await pe(l.tableId))}else o("#tableSelect").append('<option value="">No tables available</option>')}catch(r){console.error("Error loading tables:",r),o("#tableSelect").append('<option value="">Error loading tables</option>')}o("#tableSelect").on("change",async function(){const r=o(this).val();r?await pe(r):o("#columnSelect").empty().append('<option value="">\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868</option>')}),o("#processColumn").on("click",async function(){try{const r=o("#tableSelect").val(),l=o("#columnSelect").val(),m=J();if(!r||!l){b("\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868\u548C\u7B14\u8BB0\u94FE\u63A5\u5217","error");return}if(!m){b("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}if(!(o("#cookieInput").val()||"").trim()){b("\u8BF7\u586B\u5199Cookie\u4FE1\u606F","error"),o("#cookieInput").focus();return}const T=await $.base.getSelection();if(!T||!T.viewId){b("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u89C6\u56FE\u4FE1\u606F\uFF0C\u8BF7\u786E\u4FDD\u5DF2\u9009\u62E9\u4E00\u4E2A\u89C6\u56FE","error");return}b("\u8BF7\u5728\u5F39\u51FA\u7684\u5BF9\u8BDD\u6846\u4E2D\u9009\u62E9\u8981\u5904\u7406\u7684\u8BB0\u5F55...","processing");const g=await $.ui.selectRecordIdList(r,T.viewId);if(!g||g.length===0){b("\u672A\u9009\u62E9\u4EFB\u4F55\u8BB0\u5F55\uFF0C\u5DF2\u53D6\u6D88\u5904\u7406","error");return}e=!0,t=!1,o("#processColumn").prop("disabled",!0),o("#pauseProcess").show(),k(0,g.length,"\u521D\u59CB\u5316..."),b(`\u5F00\u59CB\u5904\u7406 ${g.length} \u6761\u9009\u4E2D\u6570\u636E...`,"processing");const me=await $.bridge.getBaseUserId(),Fe=await $.bridge.getInstanceId(),D=await $.base.getTableById(r),h=await Me(D),R=he().filter(p=>!h.get(p.name));if(R.length>0){console.error(`Missing selected fields: ${R.map(p=>p.name).join(", ")}`),b(`\u90E8\u5206\u5B57\u6BB5\u521B\u5EFA\u5931\u8D25: ${R.map(p=>p.label).join(", ")}. \u8BF7\u68C0\u67E5\u8868\u683C\u6743\u9650\u6216\u5237\u65B0\u9875\u9762\u91CD\u8BD5\u3002`,"error");return}let z=0,N=0,X=0;for(let p=0;p<g.length&&e;p++){const I=g[p];try{for(;t&&e;)k(p,g.length,"\u5DF2\u6682\u505C"),await new Promise(v=>setTimeout(v,1e3));if(!e)break;if(p>0){const v=Math.floor(Math.random()*201)+800;await new Promise(a=>setTimeout(a,v))}k(p,g.length,"\u83B7\u53D6\u8BB0\u5F55\u4E2D...");const F=(await D.getRecordById(I)).fields[l];if(k(p,g.length,"\u8BF7\u6C42\u6570\u636E\u4E2D..."),!F||Array.isArray(F)&&F.length===0)continue;let S="";if(Array.isArray(F)){let v=!1;for(let a=0;a<F.length;a++){const x=F[a];if(x&&typeof x=="object"&&x.type==="url"&&x.link){S=x.link,v=!0;break}}if(!v&&F.length>0){const a=F[0];a&&typeof a=="object"&&a.text&&(S=a.text)}}else typeof F=="string"?S=F:F&&typeof F=="object"&&("link"in F&&F.link?S=F.link:"text"in F&&F.text&&(S=F.text));if(!S)continue;const O=o("#cookieInput").val()||"";k(p,g.length,"API\u8BF7\u6C42\u4E2D...");const A=await fetch("https://shop.leshangyundian.com/feishu/user/vip/xhs/note",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify({url:S,cookies:O,userId:me,instanceId:Fe})});if(A.ok){const v=await A.json();if(v&&v.success===!0){z++;const a=v.data||v,x=a.videoUrl?"\u89C6\u9891":a.imageList&&a.imageList.length>0?"\u56FE\u6587":"\u6587\u672C";k(p,g.length,"\u4FDD\u5B58\u6570\u636E\u4E2D...");const E={},M=h.get("noteId");M&&(E[M]=S);const G=h.get("errorMsg");G&&(E[G]="");const Q=h.get("authorNickname");if(Q){const d=a.authorNickname||a.user&&(a.user.name||a.user.nickname)||"";E[Q]=d}const Y=h.get("authorXhsId");if(Y){const d=a.user&&a.user.userId||"";E[Y]=d}const Z=h.get("title");Z&&(E[Z]=a.title||"");const ee=h.get("description");ee&&(E[ee]=a.desc||"");const te=h.get("noteType");te&&(E[te]=x);const oe=h.get("publishTime");oe&&(E[oe]=a.createTimeStr||"");let P=[],j=[];if(a.imageList&&a.imageList.length>0){const d=a.imageList[0].imageUrl||a.imageList[0].url||"";d&&(P=await Ue(d),P.length>0);const B=a.imageList.map(y=>y.imageUrl||y.url).filter(y=>y);B.length>0&&(j=await Pe(B,(y,C,_)=>{k(p,g.length,_)}),j.length>0)}const re=h.get("videoUrl");re&&(E[re]=a.videoUrl||"");const ie=h.get("videoDuration");ie&&(E[ie]=a.videoDuration?`${a.videoDuration}\u79D2`:"");const K=h.get("tags");if(K){let d=[];a.tags&&(d=a.tags.split(",").map(B=>B.trim()).filter(B=>B));try{const B=await D.getField(K),y=await B.getOptions();if(d.length>0){const C=y.map(L=>L.name),_=d.filter(L=>!C.includes(L));_.length>0&&await B.addOptions(_.map(L=>({name:L})));const Be=(await B.getOptions()).filter(L=>d.includes(L.name)).map(L=>L.id);await B.setValue(I,Be)}else await B.setValue(I,[])}catch(B){console.error("Error handling multi-select field:",B),E[K]=[]}}const ne=h.get("likes");if(ne){const d=V(String(a.likedCount));E[ne]=d}const se=h.get("collects");if(se){const d=V(String(a.collectedCount));E[se]=d}const ue=h.get("shares");if(ue){const d=V(String(a.sharedCount));E[ue]=d}const ae=h.get("comments");if(ae){const d=V(String(a.commentsCount));E[ae]=d}const le=h.get("ipLocation");le&&(E[le]=a.ipLocation||"");const Ee=await D.getFieldMetaList(),H={};for(const[d,B]of Object.entries(E))Ee.find(C=>C.id===d)?H[d]=B:console.warn(`Field ID ${d} no longer exists, skipping...`);if(Object.keys(H).length>0){if(k(p,g.length,"\u4FDD\u5B58\u8BB0\u5F55\u6570\u636E..."),await D.setRecord(I,{fields:H}),X++,P.length>0){const y=h.get("coverUrl");if(y)try{k(p,g.length,"\u8BBE\u7F6E\u5C01\u9762\u56FE\u7247...");const C=await D.getField(y);C?(k(p,g.length,"\u4FDD\u5B58\u5C01\u9762\u56FE\u7247..."),await C.setValue(I,P)):console.error("Could not get cover field object")}catch(C){console.error("Error setting cover attachments:",C)}}if(j.length>0){const y=h.get("images");if(y)try{k(p,g.length,"\u8BBE\u7F6E\u56FE\u7247\u5217\u8868...");const C=await D.getField(y);C?(k(p,g.length,"\u4FDD\u5B58\u56FE\u7247\u5217\u8868..."),await C.setValue(I,j)):console.error("Could not get images field object")}catch(C){console.error("Error setting image attachments:",C)}}k(p+1,g.length,"\u7B49\u5F85\u9644\u4EF6\u4E0A\u4F20..."),await new Promise(y=>setTimeout(y,3e3));const d=h.get("coverUrl");if(d)try{if(k(p+1,g.length,"\u9A8C\u8BC1\u5C01\u9762\u56FE\u7247..."),await D.getField(d)){const C=await D.getCellValue(d,I)}}catch(y){console.error("Error getting cover field URLs:",y)}const B=h.get("images");if(B)try{if(k(p+1,g.length,"\u9A8C\u8BC1\u56FE\u7247\u5217\u8868..."),await D.getField(B)){const C=await D.getCellValue(B,I)}}catch(y){console.error("Error getting images field URLs:",y)}}else console.warn(`No valid fields to update for record ${I}`)}else{N++;const a=v.msg||v.message||"\u6570\u636E\u83B7\u53D6\u5931\u8D25",x=h.get("errorMsg");if(x)try{await D.setRecord(I,{fields:{[x]:a}})}catch(E){console.error(`Failed to save error message for record ${I}:`,E)}}}else{let v=A.statusText;try{const x=await A.json();v=JSON.stringify(x)}catch{v=await A.text()}console.error(`Failed to process record ${p+1}:`,A.status,v),N++;const a=h.get("errorMsg");if(a){const x={};if(x[a]=`\u9519\u8BEF ${A.status}: ${v}`,(await D.getFieldMetaList()).find(M=>M.id===a))try{await D.setRecord(I,{fields:x})}catch(M){console.error(`Failed to save error message for record ${I}:`,M)}}}}catch(U){console.error(`Error processing record ${p+1}:`,U),N++;const F=h.get("errorMsg");if(F){const S={};S[F]=`\u5904\u7406\u9519\u8BEF: ${U instanceof Error?U.message:String(U)}`;try{if((await D.getFieldMetaList()).find(A=>A.id===F))try{await D.setRecord(I,{fields:S})}catch(A){console.error(`Failed to save error message for record ${I}:`,A)}}catch(O){console.error("Failed to validate field for error message:",O)}}}}e=!1,k(g.length,g.length,"\u5B8C\u6210"),o("#processColumn").prop("disabled",!1).text("\u5F00\u59CB\u5904\u7406"),o("#pauseProcess").hide(),setTimeout(()=>{ce()},2e3);const ye=z+N,we=g.length-ye,q=`\u5904\u7406\u5B8C\u6210\uFF01
\u6210\u529F: ${z}
\u8BB0\u5F55\u66F4\u65B0: ${X}
\u5931\u8D25\u6570\u91CF: ${N}
\u8DF3\u8FC7\u7A7A\u503C: ${we}

\u5982\u679C\u9644\u4EF6\u6CA1\u6709\u663E\u793A\uFF0C\u8BF7\u5237\u65B0\u9875\u9762\u67E5\u770B\u3002`;b(q,q.includes("\u5B8C\u6210")?"success":"error")}catch(r){console.error("Error processing column:",r),b("\u5904\u7406\u5931\u8D25\uFF1A"+(r instanceof Error?r.message:String(r)),"error"),e=!1,o("#processColumn").prop("disabled",!1).text("\u5F00\u59CB\u5904\u7406"),o("#pauseProcess").hide(),ce()}}),o("#pauseProcess").on("click",function(){t=!t,o(this).text(t?"\u7EE7\u7EED\u5904\u7406":"\u6682\u505C\u5904\u7406")}),o("#refreshUserInfo").on("click",async function(){const r=J();if(!r){b("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}const l=o(this),m=l.find("svg");l.prop("disabled",!0),m.css("animation","spin 1s linear infinite");try{b("\u6B63\u5728\u5237\u65B0\u7528\u6237\u4FE1\u606F...","processing");const f=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(f.ok){const T=await f.json();T.success===!0&&T.data?(ge(T.data),W(T.data),b("\u7528\u6237\u4FE1\u606F\u5237\u65B0\u6210\u529F","success")):(b("\u5237\u65B0\u5931\u8D25\uFF1A"+(T.message||"\u672A\u77E5\u9519\u8BEF"),"error"),f.status===401&&(Ie(),b("\u6388\u6743\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55","error")))}else throw new Error(`HTTP ${f.status}: ${f.statusText}`)}catch(f){console.error("Refresh user info error:",f),b("\u5237\u65B0\u5931\u8D25\uFF1A"+(f instanceof Error?f.message:String(f)),"error")}finally{l.prop("disabled",!1),m.css("animation","")}}),o("#rechargeBtn").on("click",function(){const r=J(),l=de();if(l&&l.userId&&r){const m=`https://shop.leshangyundian.com/payment?id=${l.userId}&token=${r}&type=NOTE_VIP`;window.open(m,"_blank")}else b("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error")}),o("#selectAllFields").on("click",function(){o('input[name="fields"]:not(:disabled)').prop("checked",!0),c()}),o("#deselectAllFields").on("click",function(){o('input[name="fields"]:not(:disabled)').each(function(){o(this).prop("checked",!o(this).prop("checked"))}),c()}),o('input[name="fields"]').on("change",c),o("#cookieInput").on("input blur",function(){const r=o(this).val();r&&r.trim()&&Ce(r.trim())});function c(){const r=[];o('input[name="fields"]:checked').each(function(){const l=o(this).val();r.push(l)}),Te(r)}});

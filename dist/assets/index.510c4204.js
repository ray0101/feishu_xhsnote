import{p as I,H as b}from"./vendor-lark.d494abf6.js";import{$ as r}from"./vendor-jquery.85696251.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&l(c)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerpolicy&&(s.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?s.credentials="include":n.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function l(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();console.log("=== XHS Note Plugin Loading ===");console.log("bitable import:",I);console.log("jQuery import:",r);function B(e,o="processing"){const i=document.getElementById("status");i&&(i.textContent=e,i.className=`status ${o}`,i.style.display="block",(o==="success"||o==="error")&&setTimeout(()=>{i.style.display="none"},3e3))}function T(e,o,i){const l=`[${e}/${o}] ${i}`;r("#processColumn").text(l);const n=Math.round(e/o*100);console.log(`Updating progress bar: ${e}/${o} = ${n}%, status: ${i}`);const s=r("#progressContainer"),c=r("#progressBar"),t=r("#progressText"),a=r("#progressPercent");if(s.length===0){console.error("Progress container not found!");return}if(c.length===0){console.error("Progress bar not found!");return}s.show().addClass("show"),c.css("width",`${n}%`),c[0]&&(c[0].style.width=`${n}%`,c[0].style.minWidth="2px"),c.attr("style",`height: 100%; background: linear-gradient(90deg, #ff2442 0%, #ff6b6b 100%); width: ${n}%; border-radius: 4px; transition: width 0.3s ease; position: relative; min-width: 2px !important;`),t.text(i),a.text(`${n}%`),c[0].offsetHeight,console.log(`Progress updated: ${l} (${n}%) - bar width: ${n}%`)}function pe(){const e=r("#progressContainer");e.removeClass("show"),setTimeout(()=>{e.hide()},300)}function ve(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="visible",e.style.opacity="1")}function Be(){const e=document.getElementById("loadingOverlay");e&&(e.style.visibility="hidden",e.style.opacity="0")}async function De(){try{const e=await I.bridge.getTenantKey(),o=await I.bridge.getBaseUserId();if(console.log("Tenant key:",e),console.log("User ID:",o),!e||!o)return console.error("Missing tenant key or user ID"),{success:!1};const i=new FormData;i.append("tenantKey",e),i.append("userId",o);const l=await fetch("https://shop.leshangyundian.com/feishu/user/login",{method:"POST",body:i});if(l.ok){const n=await l.json();return console.log("Authorization response:",n),n.success===!0&&n.data?(Ie(n.data.token),ye(n.data),ee(n.data),{success:!0,data:n.data}):{success:!1}}else return console.error("Authorization failed:",l.status,l.statusText),{success:!1}}catch(e){return console.error("Authorization error:",e),{success:!1}}}function Ie(e){localStorage.setItem("xhsnote_token",e)}function Z(){return localStorage.getItem("xhsnote_token")}function ye(e){localStorage.setItem("xhsnote_user_info",JSON.stringify(e))}function he(){const e=localStorage.getItem("xhsnote_user_info");if(e)try{return JSON.parse(e)}catch(o){console.error("Failed to parse saved user info:",o)}return null}function ee(e){console.log("Displaying user info:",e),r("#userName").text(e.userName||""),e.vipLevelName?(r("#vipLevelName").text(e.vipLevelName),r("#vipLevelName").css("color","#ff2442")):(r("#vipLevelName").text("\u666E\u901A\u7528\u6237"),r("#vipLevelName").css("color","#666"));let o=!1;const i=new Date;if(e.vipExpire&&e.vipLevel>0){const l=new Date(e.vipExpire),n=l.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});o=l<i,r("#vipExpireTime").text(n),r("#vipExpireInfo").show(),o&&(r("#vipExpireInfo").find("span").eq(0).text("\u4F1A\u5458\u5DF2\u8FC7\u671F"),r("#vipExpireTime").css("color","#ff6b6b"))}else e.vipLevel===0?r("#vipExpireInfo").hide():r("#vipExpireInfo").hide();e.todayDownloadCount!==void 0?r("#todayDownloadCount").text(e.todayDownloadCount):r("#todayDownloadCount").text("0"),e.maxDailyDownloads!==void 0?r("#maxDailyDownloads").text(e.maxDailyDownloads):r("#maxDailyDownloads").text("--"),e.vipLevel===0||o?(r("#rechargeBtn").show(),o?(r("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u7EED\u8D39
      `),r("#vipLevelName").css("color","#ff6b6b")):r("#rechargeBtn").html(`
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 20M12 6L12 8M12 14L12 16M21 12H3"></path>
        </svg>
        \u5F00\u901A
      `)):r("#rechargeBtn").hide(),o&&B("\u4F1A\u5458\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u7EED\u8D39\u540E\u7EE7\u7EED\u4F7F\u7528","error"),r("#userInfo").show()}function Ce(e){localStorage.setItem("xhsnote_cookies",e)}function xe(){return localStorage.getItem("xhsnote_cookies")}function ke(){localStorage.removeItem("xhsnote_token"),localStorage.removeItem("xhsnote_user_info"),localStorage.removeItem("xhsnote_cookies")}function Se(e){if(!e)return[];const o=[],i=/#([^#\[\]]+)\[话题\]#/g;let l;for(;(l=i.exec(e))!==null;)o.push(l[1]);return o}function z(e){if(!e||typeof e!="string")return 0;const o=e.trim();if(/^\d+$/.test(o))return parseInt(o,10);const i=[/^([\d.]+)万/,/^(\d+)千\+?$/,/^([\d.]+)千$/,/^([\d.]+)k/,/^(\d+)$/];for(const l of i){const n=o.match(l);if(n){const s=parseFloat(n[1]);if(l===i[0])return Math.round(s*1e4);if(l===i[1]||l===i[2])return Math.round(s*1e3);if(l===i[3])return Math.round(s*1e3);if(l===i[4])return parseInt(String(s),10)}}return console.warn(`\u65E0\u6CD5\u89E3\u6790\u6570\u5B57\u683C\u5F0F: ${e}`),0}function Te(e){localStorage.setItem("xhsnote_selected_fields",JSON.stringify(e))}function Ae(){const e=localStorage.getItem("xhsnote_selected_fields");if(e)try{return JSON.parse(e)}catch(o){console.error("Failed to parse saved field selection:",o)}return["noteId","authorNickname","title","description","coverUrl","images"]}const me={noteId:{label:"\u5C0F\u7EA2\u4E66\u94FE\u63A5\u6216\u7B14\u8BB0ID",type:b.Text},authorNickname:{label:"\u4F5C\u8005\u6635\u79F0",type:b.Text},authorXhsId:{label:"\u4F5C\u8005\u5C0F\u7EA2\u4E66\u53F7",type:b.Text},title:{label:"\u7B14\u8BB0\u6807\u9898",type:b.Text},description:{label:"\u7B14\u8BB0\u5185\u5BB9",type:b.Text},noteType:{label:"\u7B14\u8BB0\u7C7B\u578B",type:b.Text},publishTime:{label:"\u53D1\u5E03\u65F6\u95F4",type:b.Text},coverUrl:{label:"\u5C01\u9762\u56FE",type:b.Attachment},images:{label:"\u56FE\u7247\u5217\u8868",type:b.Attachment},videoUrl:{label:"\u89C6\u9891\u5730\u5740",type:b.Url},videoDuration:{label:"\u89C6\u9891\u65F6\u957F",type:b.Text},tags:{label:"\u8BDD\u9898\u5217\u8868",type:b.MultiSelect},likes:{label:"\u70B9\u8D5E\u6570",type:b.Number},collects:{label:"\u6536\u85CF\u6570",type:b.Number},shares:{label:"\u8F6C\u53D1\u6570",type:b.Number},comments:{label:"\u8BC4\u8BBA\u6570",type:b.Number},ipLocation:{label:"\u53D1\u6587\u5730\u5740",type:b.Text},errorMsg:{label:"\u63D0\u793A\u4FE1\u606F",type:b.Text}};function $e(){const e=[];if(r('input[name="fields"]:checked').each(function(){const o=r(this).val(),i=me[o];i&&e.push({name:o,label:i.label,type:i.type})}),!e.some(o=>o.name==="errorMsg")){const o=me.errorMsg;o&&e.push({name:"errorMsg",label:o.label,type:o.type})}return e}async function Le(e,o,i){try{let n=(await e.getFieldMetaList()).find(c=>c.name===o);if(n)return n.type!==i?(console.log(`Field "${o}" exists but type mismatch. Current: ${n.type}, Required: ${i}`),console.log(`Field "${o}" ID: ${n.id}`),n.id):(console.log(`Field "${o}" already exists with ID: ${n.id}`),n.id);console.log(`Creating new field "${o}" with type: ${i}`);const s=await e.addField({type:i,name:o});return console.log(`Field "${o}" created with ID: ${s}`),s}catch(l){return console.error(`Error creating field "${o}":`,l),""}}async function Me(e,o){try{return(await e.getFieldMetaList()).some(l=>l.id===o)}catch(i){return console.error(`Field validation error for ID ${o}:`,i),!1}}async function Ne(e){const o=new Map,i=$e();if(console.log("User selected fields:",i.map(s=>s.name)),i.length===0)return B("\u8BF7\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u5B57\u6BB5","error"),o;const l=await e.getFieldMetaList();console.log("Existing fields:",l.map(s=>({name:s.name,type:s.type,id:s.id})));for(const s of l){const c=i.find(t=>t.label===s.name);if(c&&s.type!==c.type){console.log(`Deleting field ${s.name} due to type mismatch (current: ${s.type}, required: ${c.type})`);try{await e.deleteField(s.id),console.log(`Field ${s.name} deleted successfully`)}catch(t){console.error(`Failed to delete field ${s.name}:`,t)}}}await e.getFieldMetaList();for(const s of i)try{console.log(`Processing field: ${s.name}, label: ${s.label}, type: ${s.type}`);const t=await Le(e,s.label,s.type)||"";t?await Me(e,t)?(o.set(s.name,t),console.log(`Field ${s.name} -> ID: ${t} (validated)`)):(console.error(`Field ${s.name} failed validation`),o.set(s.name,t),console.log(`Field ${s.name} -> ID: ${t} (validation failed but added)`)):console.error(`Failed to get ID for field ${s.name}`)}catch(c){console.error(`Failed to create field ${s.label}:`,c)}return i.some(s=>s.name==="tags")&&(console.log("Collecting topics from all records..."),await Ue(e,o.get("tags"))),console.log(`Final field map size: ${o.size}`),console.log("Final field map entries:",Array.from(o.entries())),o}async function Ue(e,o){if(!o){console.log("Tags field ID not found, skipping topic collection");return}try{const i=await e.getRecordIdList(),l=r("#columnSelect").val(),n=new Set;if(!(await e.getRecordById(i[0])).fields[l]){console.log("No content field found for topic extraction");return}console.log(`Scanning ${i.length} records for topics...`);for(let t=0;t<Math.min(i.length,100);t++){const a=i[t];try{const m=(await e.getRecordById(a)).fields[l];m&&m.text&&Se(m.text).forEach(p=>n.add(p))}catch(F){console.error(`Error scanning record ${t}:`,F)}}console.log(`Found ${n.size} unique topics:`,Array.from(n)),n.size>0&&(await(await e.getField(o)).addOptions(Array.from(n).map(a=>({name:a}))),console.log(`Added ${n.size} topics to the multi-select field`))}catch(i){console.error("Error collecting topics:",i)}}async function Pe(e){try{let o=e;e.startsWith("http://")&&(o=e.replace("http://","https://"),console.log(`Converted HTTP to HTTPS: ${e} -> ${o}`));const i=await fetch(o,{mode:"cors"});if(!i.ok)return[];const l=await i.blob(),n=`cover_${Date.now()}.${l.type.split("/")[1]||"jpg"}`,s=new File([l],n,{type:l.type});return console.log("Created file:",s.name,s.size),[s]}catch(o){return console.error("Error processing image URL:",o),console.warn("CORS or download error. Image will be skipped."),[]}}async function Oe(e,o,i,l=3,n){let s=e;e.startsWith("http://")&&(s=e.replace("http://","https://"),console.log(`Converted HTTP to HTTPS: ${e} -> ${s}`)),console.log(`Downloading image ${o+1}/${i}:`,s);let c=null;for(let t=1;t<=l;t++)try{n&&n(`\u4E0B\u8F7D\u56FE\u7247 ${o+1}/${i} (\u5C1D\u8BD5 ${t}/${l})`),console.log(`Attempt ${t}/${l} for image ${o+1}`);const a=await fetch(s,{mode:"cors",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);n&&n(`\u8BFB\u53D6\u56FE\u7247\u6570\u636E ${o+1}/${i}`);const F=await a.blob();if(F.size===0)throw new Error("Downloaded file is empty");n&&n(`\u521B\u5EFA\u56FE\u7247\u6587\u4EF6 ${o+1}/${i}`);const m=`image_${String(o+1).padStart(3,"0")}_${Date.now()}.${F.type.split("/")[1]||"jpg"}`,C=new File([F],m,{type:F.type});return console.log(`\u2705 Successfully downloaded image ${o+1}:`,C.name,`${(F.size/1024).toFixed(2)}KB`),C}catch(a){if(c=a,console.warn(`\u274C Attempt ${t}/${l} failed for image ${o+1}:`,a instanceof Error?a.message:String(a)),t<l){const F=t*1e3;console.log(`\u23F3 Retrying image ${o+1} in ${F}ms...`),n&&n(`\u91CD\u8BD5\u4E0B\u8F7D\u56FE\u7247 ${o+1}/${i} (${F}ms\u540E\u91CD\u8BD5)`),await new Promise(m=>setTimeout(m,F))}}return console.error(`\u{1F4A5} All attempts failed for image ${o+1}:`,c),null}async function je(e,o){if(!e||e.length===0)return[];console.log(`\u{1F504} Starting to download ${e.length} images in order...`);const i=[],l=3;for(let n=0;n<e.length;n++){const s=e[n];o&&o(n+1,e.length,`\u4E0B\u8F7D\u56FE\u7247 ${n+1}/${e.length}`);try{const c=await Oe(s,n,e.length,l,t=>{o&&o(n+1,e.length,t)});c?i.push(c):console.warn(`\u26A0\uFE0F Skipped image ${n+1} due to download failure`)}catch(c){console.error(`\u{1F4A5} Unexpected error processing image ${n+1}:`,c)}n<e.length-1&&await new Promise(c=>setTimeout(c,200))}if(console.log(`\u{1F389} Download complete: ${i.length}/${e.length} images downloaded successfully`),i.length<e.length){const n=e.length-i.length;console.warn(`\u26A0\uFE0F ${n} images failed to download and will be skipped`)}return i}async function Fe(e){try{const i=await(await I.base.getTableById(e)).getFieldMetaList();if(console.log("Field list:",i),r("#columnSelect").empty(),i&&i.length>0){const l=i.filter(n=>n.type===b.Text||n.type===b.Url);if(console.log("Filtered fields:",l),l.length>0){const n=l.map(s=>{const c=s.type===b.Url?"\u94FE\u63A5":"\u6587\u672C";return`<option value="${s.id}">${s.name} (${c})</option>`}).join("");r("#columnSelect").append('<option value="">\u8BF7\u9009\u62E9\u7B14\u8BB0\u94FE\u63A5\u5217</option>'),r("#columnSelect").append(n)}else r("#columnSelect").append('<option value="">\u672A\u627E\u5230\u53EF\u7528\u7684\u7B14\u8BB0\u94FE\u63A5\u5217</option>')}else r("#columnSelect").append('<option value="">\u6CA1\u6709\u53EF\u7528\u7684\u5217</option>')}catch(o){console.error("Error loading columns:",o),r("#columnSelect").empty().append('<option value="">\u52A0\u8F7D\u5217\u5931\u8D25</option>')}}console.log("DOM ready, initializing...");r(document).ready(async function(){console.log("=== Document Ready Function Called ==="),window.addEventListener("error",function(t){console.error("Uncaught error:",t.error)}),window.addEventListener("unhandledrejection",function(t){console.error("Unhandled promise rejection:",t.reason)});let e=!1,o=!1;try{if(typeof I>"u")console.error("Bitable API not available"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3);else try{const t=await I.bridge.getEnv();console.log("Environment:",t),(!t.product||t.product!=="feishu"&&t.product!=="lark")&&(console.error("Not in Feishu or Lark environment"),setTimeout(()=>{window.location.href="https://feishu.cn"},1e3))}catch(t){console.warn("Environment check failed, but continuing:",t)}}catch(t){console.error("Environment check encountered error:",t)}const i=he();if(i&&ee(i),ve(),!(await De()).success){let t="",a="";try{const m=await I.bridge.getTenantKey(),C=await I.bridge.getBaseUserId();t=m||"\u65E0\u6CD5\u83B7\u53D6",a=C||"\u65E0\u6CD5\u83B7\u53D6"}catch(m){console.error("Failed to get debug info:",m)}const F="https://shop.leshangyundian.com/feishu/user/login";r("body").html(`
      <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #ffeef2 0%, #ffe4e8 100%);">
        <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 107, 107, 0.2); max-width: 700px;">
          <div style="font-size: 64px; margin-bottom: 20px;">\u{1F614}</div>
          <h1 style="color: #ff2442; margin-bottom: 16px;">\u6388\u6743\u5931\u8D25</h1>
          <p style="color: #666; margin-bottom: 24px;">\u65E0\u6CD5\u9A8C\u8BC1\u60A8\u7684\u6388\u6743\u4FE1\u606F\uFF0C\u8BF7\u5C06\u4EE5\u4E0B\u4FE1\u606F\u63D0\u4F9B\u7ED9\u7BA1\u7406\u5458</p>

          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <p style="margin: 0 0 10px 0;"><strong>Tenant Key:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${t}</code>

            <p style="margin: 20px 0 10px 0;"><strong>Base User ID:</strong></p>
            <code style="display: block; background: white; padding: 10px; border-radius: 6px; word-break: break-all; color: #ff2442;">${a}</code>
      </div>

          <button onclick="location.reload()" style="padding: 12px 32px; background: linear-gradient(135deg, #ff2442 0%, #ff6b6b 100%); color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; transition: transform 0.2s; margin-right: 12px;">
            \u91CD\u65B0\u52A0\u8F7D
          </button>
          <button onclick="navigator.clipboard.writeText('Tenant Key: ${t}\\nBase User ID: ${a}\\nURL: ${F}\\nFormData: tenantKey=${t}&userId=${a}')" style="padding: 12px 32px; background: white; color: #ff2442; border: 2px solid #ff2442; border-radius: 12px; font-size: 16px; cursor: pointer; transition: all 0.2s;">
            \u590D\u5236\u4FE1\u606F
          </button>
        </div>
      </div>
    `);return}Be();const n=Ae();r('input[name="fields"]').each(function(){const t=r(this).val();t==="errorMsg"?r(this).prop("checked",!0):r(this).prop("checked",n.includes(t))});const s=xe();s&&(r("#cookieInput").val(s),console.log("Loaded saved Cookie from localStorage"));try{if(console.log("bitable object:",I),console.log("bitable.base:",I.base),!I.base)throw console.error("bitable.base is undefined"),new Error("bitable.base is not available");console.log("Getting table meta list...");const t=await I.base.getTableMetaList();console.log("Table meta list result:",t),console.log("Getting selection...");const a=await I.base.getSelection();if(console.log("Selection result:",a),console.log("Table list:",t),console.log("Selection:",a),r("#tableSelect").empty(),t&&t.length>0){const F=t.map(m=>`<option value="${m.id}">${m.name}</option>`).join("");r("#tableSelect").append(F),a&&a.tableId&&(r("#tableSelect").val(a.tableId),await Fe(a.tableId))}else r("#tableSelect").append('<option value="">No tables available</option>')}catch(t){console.error("Error loading tables:",t),r("#tableSelect").append('<option value="">Error loading tables</option>')}r("#tableSelect").on("change",async function(){const t=r(this).val();console.log("Table selection changed, tableId:",t),t?await Fe(t):r("#columnSelect").empty().append('<option value="">\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868</option>')}),r("#processColumn").on("click",async function(){try{const t=r("#tableSelect").val(),a=r("#columnSelect").val(),F=Z();if(console.log("Process column clicked, tableId:",t,"fieldId:",a,"token exists:",!!F),!t||!a){B("\u8BF7\u5148\u9009\u62E9\u6570\u636E\u8868\u548C\u7B14\u8BB0\u94FE\u63A5\u5217","error");return}if(!F){B("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}if(!(r("#cookieInput").val()||"").trim()){B("\u8BF7\u586B\u5199Cookie\u4FE1\u606F","error"),r("#cookieInput").focus();return}const C=await I.base.getSelection();if(console.log("Current selection:",C),!C||!C.viewId){B("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u89C6\u56FE\u4FE1\u606F\uFF0C\u8BF7\u786E\u4FDD\u5DF2\u9009\u62E9\u4E00\u4E2A\u89C6\u56FE","error");return}B("\u8BF7\u5728\u5F39\u51FA\u7684\u5BF9\u8BDD\u6846\u4E2D\u9009\u62E9\u8981\u5904\u7406\u7684\u8BB0\u5F55...","processing");const p=await I.ui.selectRecordIdList(t,C.viewId);if(!p||p.length===0){B("\u672A\u9009\u62E9\u4EFB\u4F55\u8BB0\u5F55\uFF0C\u5DF2\u53D6\u6D88\u5904\u7406","error");return}console.log(`\u7528\u6237\u9009\u62E9\u4E86 ${p.length} \u6761\u8BB0\u5F55:`,p),e=!0,o=!1,r("#processColumn").prop("disabled",!0),r("#pauseProcess").show(),T(0,p.length,"\u521D\u59CB\u5316..."),B(`\u5F00\u59CB\u5904\u7406 ${p.length} \u6761\u9009\u4E2D\u6570\u636E...`,"processing");const oe=await I.bridge.getBaseUserId(),te=await I.bridge.getInstanceId();console.log("User ID:",oe,"Instance ID:",te);const k=await I.base.getTableById(t),y=await Ne(k),V=$e().filter(f=>!y.get(f.name));if(V.length>0){console.error(`Missing selected fields: ${V.map(f=>f.name).join(", ")}`),B(`\u90E8\u5206\u5B57\u6BB5\u521B\u5EFA\u5931\u8D25: ${V.map(f=>f.label).join(", ")}. \u8BF7\u68C0\u67E5\u8868\u683C\u6743\u9650\u6216\u5237\u65B0\u9875\u9762\u91CD\u8BD5\u3002`,"error");return}let H=0,N=0,ne=0;for(let f=0;f<p.length&&e;f++){const g=p[f];try{for(;o&&e;)T(f,p.length,"\u5DF2\u6682\u505C"),await new Promise(v=>setTimeout(v,1e3));if(!e)break;if(f>0){const v=Math.floor(Math.random()*201)+800;console.log(`Waiting ${v}ms before request...`),await new Promise(u=>setTimeout(u,v))}T(f,p.length,"\u83B7\u53D6\u8BB0\u5F55\u4E2D...");const $=(await k.getRecordById(g)).fields[a];if(console.log(`Record ${f+1}/${p.length}, value:`,$),T(f,p.length,"\u8BF7\u6C42\u6570\u636E\u4E2D..."),!$||Array.isArray($)&&$.length===0){console.log(`Skipping empty value for record ${f+1}`);continue}let x="";if(Array.isArray($)){let v=!1;for(let u=0;u<$.length;u++){const S=$[u];if(S&&typeof S=="object"&&S.type==="url"&&S.link){x=S.link,v=!0,console.log(`Extracted link from array item ${u}: ${x}`);break}}if(!v&&$.length>0){const u=$[0];u&&typeof u=="object"&&u.text&&(x=u.text,console.log(`No link found, using text from first item: ${x}`))}}else typeof $=="string"?(x=$,console.log(`Using string value: ${x}`)):$&&typeof $=="object"&&("link"in $&&$.link?(x=$.link,console.log(`Extracted link from object: ${x}`)):"text"in $&&$.text&&(x=$.text,console.log(`Extracted text from object: ${x}`)));if(!x){console.log(`Skipping record ${f+1}: no valid noteId found`);continue}console.log(`Sending request for noteId: ${x}`);const _=r("#cookieInput").val()||"";T(f,p.length,"API\u8BF7\u6C42\u4E2D...");const A=await fetch("https://shop.leshangyundian.com/feishu/user/vip/xhs/note",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${F}`},body:JSON.stringify({url:x,cookies:_,userId:oe,instanceId:te})});if(A.ok){const v=await A.json();if(console.log(`Successfully processed record ${f+1}:`,v),v&&v.success===!0){H++;const u=v.data||v,S=u.videoUrl?"\u89C6\u9891":u.imageList&&u.imageList.length>0?"\u56FE\u6587":"\u6587\u672C";T(f,p.length,"\u4FDD\u5B58\u6570\u636E\u4E2D...");const w={};console.log("Field ID Map:",Array.from(y.entries()));const M=y.get("noteId");console.log("noteIdField:",M),M&&(w[M]=x);const ie=y.get("errorMsg");ie&&(w[ie]="");const K=y.get("authorNickname");if(K){const d=u.authorNickname||u.user&&(u.user.name||u.user.nickname)||"";w[K]=d,console.log(`\u2713 Setting authorNickname: ${d} (fieldId: ${K})`)}else console.log("\u2717 authorNickname field not found in fieldIdMap");const X=y.get("authorXhsId");if(X){const d=u.user&&u.user.userId||"";w[X]=d,console.log(`\u2713 Setting authorXhsId: ${d} (fieldId: ${X})`)}else console.log("\u2717 authorXhsId field not found in fieldIdMap");const se=y.get("title");se&&(w[se]=u.title||"");const le=y.get("description");le&&(w[le]=u.desc||"");const ue=y.get("noteType");ue&&(w[ue]=S);const ae=y.get("publishTime");ae&&(w[ae]=u.createTimeStr||"");let P=[],O=[];if(u.imageList&&u.imageList.length>0){const d=u.imageList[0].imageUrl||u.imageList[0].url||"";d&&(P=await Pe(d),P.length>0?console.log(`Downloaded ${P.length} cover image(s) for record ${g}`):console.log(`Skipping cover image for record ${g} due to download error`));const E=u.imageList.map(h=>h.imageUrl||h.url).filter(h=>h);E.length>0&&(console.log(`Processing ${E.length} images for record ${g}...`),O=await je(E,(h,D,j)=>{T(f,p.length,j)}),O.length>0?console.log(`Downloaded ${O.length} images for record ${g}`):console.log(`No images were processed for record ${g}`))}const ce=y.get("videoUrl");ce&&(w[ce]=u.videoUrl||"");const de=y.get("videoDuration");de&&(w[de]=u.videoDuration?`${u.videoDuration}\u79D2`:"");const q=y.get("tags");if(q){let d=[];u.tags&&(d=u.tags.split(",").map(E=>E.trim()).filter(E=>E)),console.log(`Tags for record ${g}:`,d);try{const E=await k.getField(q),h=await E.getOptions();if(console.log("Existing options:",h),d.length>0){const D=h.map(L=>L.name),j=d.filter(L=>!D.includes(L));j.length>0&&(console.log("Adding new options:",j),await E.addOptions(j.map(L=>({name:L}))));const fe=await E.getOptions();console.log("Updated options:",fe);const Y=fe.filter(L=>d.includes(L.name)).map(L=>L.id);console.log("Selected option IDs:",Y),await E.setValue(g,Y),console.log(`Set ${Y.length} tags for record ${g}:`,d)}else await E.setValue(g,[]),console.log(`No tags found, cleared tags for record ${g}`)}catch(E){console.error("Error handling multi-select field:",E),w[q]=[]}}const W=y.get("likes");if(W){const d=z(String(u.likedCount));w[W]=d,console.log(`\u2713 Setting likes: ${u.likedCount} -> ${d} (fieldId: ${W})`)}const G=y.get("collects");if(G){const d=z(String(u.collectedCount));w[G]=d,console.log(`\u2713 Setting collects: ${u.collectedCount} -> ${d} (fieldId: ${G})`)}else console.log("\u2717 collects field not found in fieldIdMap");const J=y.get("shares");if(J){const d=z(String(u.sharedCount));w[J]=d,console.log(`\u2713 Setting shares: ${u.sharedCount} -> ${d} (fieldId: ${J})`)}const Q=y.get("comments");if(Q){const d=z(String(u.commentsCount));w[Q]=d,console.log(`\u2713 Setting comments: ${u.commentsCount} -> ${d} (fieldId: ${Q})`)}const ge=y.get("ipLocation");ge&&(w[ge]=u.ipLocation||""),console.log("Validating field IDs before update..."),console.log("Fields to update count:",Object.keys(w).length);const be=await k.getFieldMetaList(),R={};for(const[d,E]of Object.entries(w)){const h=be.find(D=>D.id===d);h?(R[d]=E,console.log(`Field ${h.name} (ID: ${d}) is valid`)):console.warn(`Field ID ${d} no longer exists, skipping...`)}if(Object.keys(R).length>0){if(console.log(`Updating record ${g} with ${Object.keys(R).length} fields...`),T(f,p.length,"\u4FDD\u5B58\u8BB0\u5F55\u6570\u636E..."),await k.setRecord(g,{fields:R}),ne++,console.log(`Record ${f+1} updated successfully`),P.length>0){const h=y.get("coverUrl");if(h)try{console.log(`Getting cover field for ID: ${h}`),T(f,p.length,"\u8BBE\u7F6E\u5C01\u9762\u56FE\u7247...");const D=await k.getField(h);D?(console.log(`Setting cover attachments for record ${g}...`),T(f,p.length,"\u4FDD\u5B58\u5C01\u9762\u56FE\u7247..."),await D.setValue(g,P),console.log(`Cover attachments set for record ${g}`)):console.error("Could not get cover field object")}catch(D){console.error("Error setting cover attachments:",D)}}if(O.length>0){const h=y.get("images");if(h)try{console.log(`Getting images field for ID: ${h}`),T(f,p.length,"\u8BBE\u7F6E\u56FE\u7247\u5217\u8868...");const D=await k.getField(h);D?(console.log(`Setting image attachments for record ${g}...`),T(f,p.length,"\u4FDD\u5B58\u56FE\u7247\u5217\u8868..."),await D.setValue(g,O),console.log(`Image attachments set for record ${g}`)):console.error("Could not get images field object")}catch(D){console.error("Error setting image attachments:",D)}}T(f+1,p.length,"\u7B49\u5F85\u9644\u4EF6\u4E0A\u4F20..."),await new Promise(h=>setTimeout(h,3e3));const d=y.get("coverUrl");if(d)try{if(T(f+1,p.length,"\u9A8C\u8BC1\u5C01\u9762\u56FE\u7247..."),await k.getField(d)){const D=await k.getCellValue(d,g);console.log(`Cover cell value for record ${g}:`,D)}}catch(h){console.error("Error getting cover field URLs:",h)}const E=y.get("images");if(E)try{if(T(f+1,p.length,"\u9A8C\u8BC1\u56FE\u7247\u5217\u8868..."),await k.getField(E)){const D=await k.getCellValue(E,g);console.log(`Images cell value for record ${g}:`,D)}}catch(h){console.error("Error getting images field URLs:",h)}}else console.warn(`No valid fields to update for record ${g}`)}else{console.log(`API returned success=false for record ${f+1}`),N++;const u=v.msg||v.message||"\u6570\u636E\u83B7\u53D6\u5931\u8D25",S=y.get("errorMsg");if(S)try{await k.setRecord(g,{fields:{[S]:u}}),console.log(`Error message saved for record ${g}: ${u}`)}catch(w){console.error(`Failed to save error message for record ${g}:`,w)}}}else{let v=A.statusText;try{const S=await A.json();v=JSON.stringify(S)}catch{v=await A.text()}console.error(`Failed to process record ${f+1}:`,A.status,v),N++;const u=y.get("errorMsg");if(u){const S={};if(S[u]=`\u9519\u8BEF ${A.status}: ${v}`,(await k.getFieldMetaList()).find(M=>M.id===u))try{await k.setRecord(g,{fields:S}),console.log(`Error message saved for record ${g}`)}catch(M){console.error(`Failed to save error message for record ${g}:`,M)}}}}catch(U){console.error(`Error processing record ${f+1}:`,U),N++;const $=y.get("errorMsg");if($){const x={};x[$]=`\u5904\u7406\u9519\u8BEF: ${U instanceof Error?U.message:String(U)}`;try{if((await k.getFieldMetaList()).find(A=>A.id===$))try{await k.setRecord(g,{fields:x}),console.log(`Error message saved for record ${g}`)}catch(A){console.error(`Failed to save error message for record ${g}:`,A)}}catch(_){console.error("Failed to validate field for error message:",_)}}}}e=!1,T(p.length,p.length,"\u5B8C\u6210"),r("#processColumn").prop("disabled",!1).text("\u5F00\u59CB\u5904\u7406"),r("#pauseProcess").hide(),setTimeout(()=>{pe()},2e3);const we=H+N,Ee=p.length-we,re=`\u5904\u7406\u5B8C\u6210\uFF01
\u6210\u529F: ${H}
\u8BB0\u5F55\u66F4\u65B0: ${ne}
\u5931\u8D25\u6570\u91CF: ${N}
\u8DF3\u8FC7\u7A7A\u503C: ${Ee}

\u5982\u679C\u9644\u4EF6\u6CA1\u6709\u663E\u793A\uFF0C\u8BF7\u5237\u65B0\u9875\u9762\u67E5\u770B\u3002`;B(re,re.includes("\u5B8C\u6210")?"success":"error")}catch(t){console.error("Error processing column:",t),B("\u5904\u7406\u5931\u8D25\uFF1A"+(t instanceof Error?t.message:String(t)),"error"),e=!1,r("#processColumn").prop("disabled",!1).text("\u5F00\u59CB\u5904\u7406"),r("#pauseProcess").hide(),pe()}}),r("#pauseProcess").on("click",function(){o=!o,r(this).text(o?"\u7EE7\u7EED\u5904\u7406":"\u6682\u505C\u5904\u7406")}),r("#refreshUserInfo").on("click",async function(){const t=Z();if(!t){B("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error");return}const a=r(this),F=a.find("svg");a.prop("disabled",!0),F.css("animation","spin 1s linear infinite");try{console.log("Refreshing user info..."),B("\u6B63\u5728\u5237\u65B0\u7528\u6237\u4FE1\u606F...","processing");const m=await fetch("https://shop.leshangyundian.com/feishu/user/info",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}});if(m.ok){const C=await m.json();console.log("User info refreshed:",C),C.success===!0&&C.data?(ye(C.data),ee(C.data),B("\u7528\u6237\u4FE1\u606F\u5237\u65B0\u6210\u529F","success")):(B("\u5237\u65B0\u5931\u8D25\uFF1A"+(C.message||"\u672A\u77E5\u9519\u8BEF"),"error"),m.status===401&&(ke(),B("\u6388\u6743\u5DF2\u8FC7\u671F\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55","error")))}else throw new Error(`HTTP ${m.status}: ${m.statusText}`)}catch(m){console.error("Refresh user info error:",m),B("\u5237\u65B0\u5931\u8D25\uFF1A"+(m instanceof Error?m.message:String(m)),"error")}finally{a.prop("disabled",!1),F.css("animation","")}}),r("#rechargeBtn").on("click",function(){const t=Z(),a=he();if(a&&a.userId&&t){const F=`https://shop.leshangyundian.com/payment?id=${a.userId}&token=${t}&type=NOTE_VIP`;window.open(F,"_blank")}else B("\u8BF7\u5148\u91CD\u65B0\u767B\u5F55\u83B7\u53D6\u6388\u6743","error")}),r("#selectAllFields").on("click",function(){r('input[name="fields"]:not(:disabled)').prop("checked",!0),c()}),r("#deselectAllFields").on("click",function(){r('input[name="fields"]:not(:disabled)').each(function(){r(this).prop("checked",!r(this).prop("checked"))}),c()}),r('input[name="fields"]').on("change",c),r("#cookieInput").on("input blur",function(){const t=r(this).val();t&&t.trim()&&(Ce(t.trim()),console.log("Cookie saved to localStorage"))});function c(){const t=[];r('input[name="fields"]:checked').each(function(){const a=r(this).val();t.push(a)}),Te(t)}});
